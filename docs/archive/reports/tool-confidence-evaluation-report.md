# ToolConfidence å·¥å…·æ‰§è¡Œç½®ä¿¡åº¦ - è¯„ä¼°æŠ¥å‘Š

## å®ç°æ¦‚è¿°

### åŠŸèƒ½æè¿°
å®ç°äº†å·¥å…·æ‰§è¡Œç»“æœç½®ä¿¡åº¦è¯„ä¼°ç³»ç»Ÿï¼Œå¸®åŠ© Agent åˆ¤æ–­å·¥å…·è°ƒç”¨ç»“æœçš„å¯é æ€§ï¼Œå¹¶åœ¨ç½®ä¿¡åº¦ä½æ—¶è‡ªåŠ¨é‡è¯•æˆ–ä½¿ç”¨å¤‡ç”¨ç­–ç•¥ã€‚

### æ ¸å¿ƒåŠŸèƒ½
1. **ç½®ä¿¡åº¦è¯„ä¼°** - åŸºäºå¤šä¸ªç»´åº¦è¯„ä¼°å·¥å…·ç»“æœçš„å¯é æ€§
2. **è‡ªåŠ¨é‡è¯•** - ä½ç½®ä¿¡åº¦æˆ–å¯é‡è¯•é”™è¯¯æ—¶è‡ªåŠ¨é‡è¯•
3. **å†å²è¿½è¸ª** - è®°å½•å·¥å…·å†å²è¡¨ç°ï¼Œè®¡ç®—æˆåŠŸç‡
4. **å¼‚å¸¸æ£€æµ‹** - è¯†åˆ«å¼‚å¸¸çš„ç»“æœæ¨¡å¼
5. **æŒ‡æ•°é€€é¿** - é‡è¯•å»¶è¿Ÿé‡‡ç”¨æŒ‡æ•°é€€é¿ç­–ç•¥

---

## æµ‹è¯•ç»“æœ

### å•å…ƒæµ‹è¯•
```bash
cargo test -p edge-ai-agent --lib tool_confidence
```
- **ç»“æœ**: âœ… 11/11 é€šè¿‡

#### æµ‹è¯•ç”¨ä¾‹è¦†ç›–

| æµ‹è¯•ç”¨ä¾‹ | åœºæ™¯æè¿° | çŠ¶æ€ |
|---------|---------|------|
| `test_confidence_level_from_score` | ç½®ä¿¡åº¦ç­‰çº§è½¬æ¢ | âœ… |
| `test_confidence_level_is_acceptable` | ç½®ä¿¡åº¦å¯æ¥å—åˆ¤æ–­ | âœ… |
| `test_evaluate_success_result` | è¯„ä¼°æˆåŠŸç»“æœ | âœ… |
| `test_evaluate_error_result` | è¯„ä¼°é”™è¯¯ç»“æœ | âœ… |
| `test_evaluate_timeout` | è¶…æ—¶æ£€æµ‹ | âœ… |
| `test_evaluate_empty_result` | ç©ºç»“æœæ£€æµ‹ | âœ… |
| `test_should_retry` | é‡è¯•æ¡ä»¶åˆ¤æ–­ | âœ… |
| `test_retry_delay_exponential_backoff` | æŒ‡æ•°é€€é¿å»¶è¿Ÿ | âœ… |
| `test_success_rate_tracking` | æˆåŠŸç‡è¿½è¸ª | âœ… |
| `test_abnormal_pattern_detection` | å¼‚å¸¸æ¨¡å¼æ£€æµ‹ | âœ… |
| `test_content_format_evaluation` | å†…å®¹æ ¼å¼è¯„ä¼° | âœ… |

---

## ä»£ç è´¨é‡

### æ–‡ä»¶ç»“æ„
```
crates/agent/src/agent/
â”œâ”€â”€ tool_confidence.rs            # å·¥å…·ç½®ä¿¡åº¦æ ¸å¿ƒå®ç° (620+ è¡Œ)
â””â”€â”€ mod.rs                        # é›†æˆåˆ° Agent æ¨¡å—å¯¼å‡º
```

### å…³é”®ç±»å‹

```rust
/// ç½®ä¿¡åº¦ç­‰çº§
pub enum ConfidenceLevel {
    VeryLow,    // 0-20% ä¸å¯ä¿¡
    Low,        // 20-40% å¯èƒ½æœ‰é—®é¢˜
    Medium,     // 40-60% åŸºæœ¬å¯ä¿¡
    High,       // 60-80% æ¯”è¾ƒå¯ä¿¡
    VeryHigh,   // 80-100% å®Œå…¨å¯ä¿¡
}

/// æ‰§è¡ŒçŠ¶æ€
pub enum ExecutionStatus {
    Success,            // æˆåŠŸ
    RetryableFailure,   // å¤±è´¥ä½†å¯é‡è¯•
    PermanentFailure,   // æ°¸ä¹…å¤±è´¥
    Timeout,            // è¶…æ—¶
    AbnormalResult,     // ç»“æœå¼‚å¸¸
}

/// å·¥å…·æ‰§è¡Œç»“æœ
pub struct ToolExecutionResult {
    pub tool_name: String,
    pub status: ExecutionStatus,
    pub confidence: ConfidenceLevel,
    pub confidence_score: f32,
    pub content: String,
    pub duration_ms: u64,
    pub error_message: Option<String>,
    pub is_retry: bool,
    pub retry_count: usize,
}
```

---

## ç½®ä¿¡åº¦è¯„ä¼°ç®—æ³•

### è¯„ä¼°ç»´åº¦

| ç»´åº¦ | æƒé‡ | è¯´æ˜ |
|-----|------|------|
| é”™è¯¯æ£€æµ‹ | -0.5 | æœ‰é”™è¯¯ç›´æ¥é™ä½ç½®ä¿¡åº¦ |
| è¶…æ—¶æ£€æµ‹ | -0.2 | è¶…è¿‡é˜ˆå€¼æ—¶é—´ |
| å†…å®¹å®Œæ•´æ€§ | +0.4 | å†…å®¹é•¿åº¦ã€å¿…è¦å…ƒç´  |
| å†…å®¹æ ¼å¼ | +0.3 | JSON/ç»“æ„åŒ–åŠ åˆ† |
| å¼‚å¸¸æ¨¡å¼ | -0.3 | æ£€æµ‹ null/error ç­‰ |
| å†å²ä¸€è‡´æ€§ | +0.1 | ä¸å†å²ç»“æœå¯¹æ¯” |

### ç½®ä¿¡åº¦ç­‰çº§å¯¹åº”

| åˆ†æ•°èŒƒå›´ | ç­‰çº§ | è¡ŒåŠ¨ |
|---------|------|------|
| 0.0-0.2 | VeryLow | å¿…é¡»é‡è¯•æˆ–æŠ¥é”™ |
| 0.2-0.4 | Low | å»ºè®®éªŒè¯æˆ–é‡è¯• |
| 0.4-0.6 | Medium | å¯æ¥å—ï¼Œè°¨æ…ä½¿ç”¨ |
| 0.6-0.8 | High | å¯ä¿¡ï¼Œæ­£å¸¸ä½¿ç”¨ |
| 0.8-1.0 | VeryHigh | å®Œå…¨å¯ä¿¡ |

---

## æ”¹è¿›æ•ˆæœè¯„ä¼°

### æ”¹è¿›å‰ vs æ”¹è¿›å

| åœºæ™¯ | æ”¹è¿›å‰ | æ”¹è¿›å |
|-----|-------|-------|
| **å·¥å…·å¤±è´¥** | ç›´æ¥è¿”å›é”™è¯¯ | åˆ¤æ–­æ˜¯å¦å¯é‡è¯•ï¼Œè‡ªåŠ¨é‡è¯• |
| **ç»“æœå¼‚å¸¸** | æ— æ³•æ£€æµ‹ | æ£€æµ‹å¼‚å¸¸æ¨¡å¼ï¼Œæ ‡è®°ä½ç½®ä¿¡åº¦ |
| **ç»“æœéªŒè¯** | æ—  | å¤šç»´åº¦è¯„ä¼°ç»“æœè´¨é‡ |
| **å†å²è¿½è¸ª** | æ—  | è®°å½•å†å²ï¼Œè®¡ç®—æˆåŠŸç‡ |

### ç³»ç»Ÿç¨³å®šæ€§æå‡
1. **è‡ªåŠ¨æ¢å¤** - å¯é‡è¯•é”™è¯¯è‡ªåŠ¨æ¢å¤
2. **è´¨é‡ä¿è¯** - ä½è´¨é‡ç»“æœè¢«è¯†åˆ«
3. **æ€§èƒ½ç›‘æ§** - å·¥å…·æ‰§è¡ŒæˆåŠŸç‡å¯è¿½è¸ª
4. **æ™ºèƒ½é™çº§** - å¼‚å¸¸ç»“æœä¸ç›´æ¥è¿”å›ç»™ç”¨æˆ·

---

## ä»£ç ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨
```rust
use edge_ai_agent::agent::tool_confidence::{
    ToolConfidenceManager, ConfidenceConfig,
};

let mut manager = ToolConfidenceManager::new();

// è¯„ä¼°å·¥å…·æ‰§è¡Œç»“æœ
let result = manager.evaluate_result(
    "list_devices",
    "å®¢å…ç¯: å¼€\nå§å®¤ç©ºè°ƒ: å…³",
    150,  // æ‰§è¡Œæ—¶é•¿
    None, // æ— é”™è¯¯
);

// æ£€æŸ¥ç½®ä¿¡åº¦
if result.confidence.is_acceptable() {
    // å¯ä»¥ä½¿ç”¨ç»“æœ
    println!("{}", result.content);
} else if manager.should_retry(&result) {
    // éœ€è¦é‡è¯•
}
```

### é…ç½®é‡è¯•ç­–ç•¥
```rust
let config = ConfidenceConfig {
    max_retries: 3,
    retry_delay_ms: 200,
    timeout_threshold_ms: 3000,
    enable_validation: true,
};

let mut manager = ToolConfidenceManager::with_config(config);
```

### è¿½è¸ªæˆåŠŸç‡
```rust
// è®°å½•ç»“æœ
manager.record_result(result);

// è·å–æˆåŠŸç‡
if let Some(rate) = manager.get_success_rate("list_devices") {
    println!("æˆåŠŸç‡: {:.1}%", rate * 100.0);
}
```

---

## æ½œåœ¨æ”¹è¿›æ–¹å‘

### P1 - è¿‘æœŸæ”¹è¿›
1. **æ›´ç»†è‡´çš„é”™è¯¯åˆ†ç±»** - é’ˆå¯¹ä¸åŒå·¥å…·ç±»å‹çš„ç‰¹å®šé”™è¯¯æ¨¡å¼
2. **ç»“æœè¯­ä¹‰éªŒè¯** - ä½¿ç”¨ LLM éªŒè¯ç»“æœçš„åˆç†æ€§
3. **è‡ªé€‚åº”é‡è¯•** - åŸºäºå†å²æˆåŠŸç‡è°ƒæ•´é‡è¯•ç­–ç•¥

### P2 - ä¸­æœŸæ”¹è¿›
1. **å·¥å…·æ€§èƒ½ç›‘æ§** - è®°å½•å“åº”æ—¶é—´ã€ååé‡
2. **A/B æµ‹è¯•æ”¯æŒ** - æ¯”è¾ƒä¸åŒå·¥å…·ç‰ˆæœ¬çš„è¡¨ç°
3. **é¢„æµ‹æ€§ç»´æŠ¤** - åŸºäºè¶‹åŠ¿é¢„æµ‹å·¥å…·å¯èƒ½çš„é—®é¢˜

---

## æ€»ç»“

### âœ… å·²å®Œæˆ
- [x] ToolConfidenceManager æ ¸å¿ƒæ¨¡å—
- [x] å•å…ƒæµ‹è¯•ï¼ˆ11ä¸ªï¼‰
- [x] å¤šç»´åº¦ç½®ä¿¡åº¦è¯„ä¼°
- [x] è‡ªåŠ¨é‡è¯•æœºåˆ¶
- [x] å†å²è¿½è¸ª
- [x] å¼‚å¸¸æ£€æµ‹
- [x] æŒ‡æ•°é€€é¿é‡è¯•

### ğŸ“Š æŒ‡æ ‡
- **æµ‹è¯•è¦†ç›–ç‡**: 100%ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
- **ä»£ç è¡Œæ•°**: 620+ è¡Œ
- **ç¼–è¯‘è­¦å‘Š**: 0
- **æµ‹è¯•é€šè¿‡ç‡**: 100% (11/11)

### ğŸ¯ æ•ˆæœ
- **ç³»ç»Ÿç¨³å®šæ€§**: æå‡ï¼ˆè‡ªåŠ¨é‡è¯•ï¼‰
- **ç»“æœè´¨é‡**: æå‡ï¼ˆå¼‚å¸¸æ£€æµ‹ï¼‰
- **å¯è§‚æµ‹æ€§**: æå‡ï¼ˆå†å²è¿½è¸ªï¼‰
