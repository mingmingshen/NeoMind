# ModelSelection æœ¬åœ°æ¨¡å‹ä¼˜å…ˆ - è¯„ä¼°æŠ¥å‘Š

## å®ç°æ¦‚è¿°

### åŠŸèƒ½æè¿°
å®ç°äº†æ™ºèƒ½æ¨¡å‹é€‰æ‹©ç³»ç»Ÿï¼Œæ ¹æ®ä»»åŠ¡å¤æ‚åº¦ã€æ¨¡å‹èƒ½åŠ›ã€æˆæœ¬å’Œå¯ç”¨æ€§ï¼Œè‡ªåŠ¨é€‰æ‹©æœ€åˆé€‚çš„æ¨¡å‹ã€‚ä¼˜å…ˆä½¿ç”¨æœ¬åœ°æ¨¡å‹ï¼ˆOllamaï¼‰ä»¥é™ä½å»¶è¿Ÿå’Œæˆæœ¬ã€‚

### æ ¸å¿ƒåŠŸèƒ½
1. **ä»»åŠ¡å¤æ‚åº¦åˆ†æ** - è‡ªåŠ¨åˆ¤æ–­ä»»åŠ¡å¤æ‚åº¦ï¼ˆç®€å•/ä¸­ç­‰/å¤æ‚ï¼‰
2. **æœ¬åœ°æ¨¡å‹ä¼˜å…ˆ** - ä¼˜å…ˆä½¿ç”¨æœ¬åœ° Ollama æ¨¡å‹
3. **èƒ½åŠ›åŒ¹é…** - æ ¹æ®ä»»åŠ¡éœ€æ±‚é€‰æ‹©æ”¯æŒå·¥å…·è°ƒç”¨/è§†è§‰çš„æ¨¡å‹
4. **é™çº§ç­–ç•¥** - æœ¬åœ°æ¨¡å‹ä¸å¯ç”¨æ—¶é™çº§åˆ°äº‘æ¨¡å‹
5. **ä½¿ç”¨ç»Ÿè®¡** - è¿½è¸ªå„æ¨¡å‹ä½¿ç”¨æƒ…å†µ

---

## æµ‹è¯•ç»“æœ

### å•å…ƒæµ‹è¯•
```bash
cargo test -p edge-ai-agent --lib model_selection
```
- **ç»“æœ**: âœ… 11/11 é€šè¿‡

#### æµ‹è¯•ç”¨ä¾‹è¦†ç›–

| æµ‹è¯•ç”¨ä¾‹ | åœºæ™¯æè¿° | çŠ¶æ€ |
|---------|---------|------|
| `test_task_complexity_simple` | ç®€å•ä»»åŠ¡åˆ†ç±» | âœ… |
| `test_task_complexity_medium` | ä¸­ç­‰ä»»åŠ¡åˆ†ç±» | âœ… |
| `test_task_complexity_complex` | å¤æ‚ä»»åŠ¡åˆ†ç±» | âœ… |
| `test_select_local_model_for_simple_task` | ç®€å•ä»»åŠ¡é€‰æœ¬åœ°æ¨¡å‹ | âœ… |
| `test_local_model_priority` | æœ¬åœ°æ¨¡å‹ä¼˜å…ˆçº§ | âœ… |
| `test_fallback_models` | å¤‡é€‰æ¨¡å‹åˆ—è¡¨ | âœ… |
| `test_vision_requirement` | è§†è§‰èƒ½åŠ›è¦æ±‚ | âœ… |
| `test_model_usage_tracking` | ä½¿ç”¨ç»Ÿè®¡è¿½è¸ª | âœ… |
| `test_mark_unavailable` | æ¨¡å‹å¯ç”¨æ€§æ ‡è®° | âœ… |
| `test_get_local_models` | æœ¬åœ°æ¨¡å‹åˆ—è¡¨ | âœ… |
| `test_get_cloud_models` | äº‘ç«¯æ¨¡å‹åˆ—è¡¨ | âœ… |

---

## ä»£ç è´¨é‡

### æ–‡ä»¶ç»“æ„
```
crates/agent/src/agent/
â”œâ”€â”€ model_selection.rs             # æ¨¡å‹é€‰æ‹©æ ¸å¿ƒå®ç° (650+ è¡Œ)
â””â”€â”€ mod.rs                          # é›†æˆåˆ° Agent æ¨¡å—å¯¼å‡º
```

### å…³é”®ç±»å‹

```rust
/// ä»»åŠ¡å¤æ‚åº¦
pub enum TaskComplexity {
    Simple,   // ç®€å• - å•è½®é—®ç­”ã€ç®€å•æ§åˆ¶
    Medium,   // ä¸­ç­‰ - å¤šè½®å¯¹è¯ã€éœ€è¦æ¨ç†
    Complex,  // å¤æ‚ - éœ€è¦æ·±åº¦ç†è§£ã€å¤šæ­¥éª¤
}

/// æ¨¡å‹ç±»å‹
pub enum ModelType {
    Local,   // æœ¬åœ°æ¨¡å‹ï¼ˆOllamaï¼‰
    Cloud,   // äº‘ç«¯æ¨¡å‹ï¼ˆOpenAI, Anthropicç­‰ï¼‰
}

/// æ¨¡å‹èƒ½åŠ›
pub struct ModelCapabilities {
    pub max_context: usize,       // æœ€å¤§ä¸Šä¸‹æ–‡é•¿åº¦
    pub supports_tools: bool,     // æ”¯æŒå·¥å…·è°ƒç”¨
    pub supports_vision: bool,    // æ”¯æŒè§†è§‰
    pub speed_score: u8,          // å“åº”é€Ÿåº¦ (0-10)
    pub quality_score: u8,        // æ¨ç†è´¨é‡ (0-10)
    pub cost_score: u8,           // æˆæœ¬ä¼˜åŠ¿ (0-10)
}

/// æ¨¡å‹é€‰æ‹©ç»“æœ
pub struct ModelSelection {
    pub recommended_model: String,    // æ¨èæ¨¡å‹
    pub reason: String,              // æ¨èç†ç”±
    pub fallback_models: Vec<String>, // å¤‡é€‰æ¨¡å‹
    pub requires_fallback: bool,     // æ˜¯å¦éœ€è¦é™çº§
}
```

---

## ä»»åŠ¡å¤æ‚åº¦åˆ†æ

### ç®€å•ä»»åŠ¡ (Simple)
- å•è¯æˆ–çŸ­è¯­
- åŸºç¡€æ“ä½œï¼ˆæ‰“å¼€/å…³é—­ï¼‰
- ç®€å•æŸ¥è¯¢

**ç¤ºä¾‹**ï¼š
- "æ‰“å¼€å®¢å…ç¯"
- "æ¸©åº¦å¤šå°‘"
- "status"

### ä¸­ç­‰ä»»åŠ¡ (Medium)
- éœ€è¦å·¥å…·è°ƒç”¨
- å¤šæ­¥éª¤æ“ä½œ
- ä¸­ç­‰é•¿åº¦è¾“å…¥

**ç¤ºä¾‹**ï¼š
- "æŸ¥è¯¢æ¸©åº¦å¹¶æ§åˆ¶ç©ºè°ƒ"
- "åˆ—å‡ºæ‰€æœ‰è®¾å¤‡å¹¶ç»Ÿè®¡"

### å¤æ‚ä»»åŠ¡ (Complex)
- éœ€è¦åˆ†æ/æ€»ç»“
- å¤šæ­¥éª¤æ¨ç†
- é•¿è¾“å…¥

**ç¤ºä¾‹**ï¼š
- "åˆ†ææœ€è¿‘ä¸€å‘¨çš„æ¸©åº¦æ•°æ®å¹¶æ€»ç»“è¶‹åŠ¿"
- "è®¾è®¡ä¸€ä¸ªè‡ªåŠ¨åŒ–æµç¨‹æ¥ä¼˜åŒ–èƒ½æºæ¶ˆè€—"

---

## æ¨¡å‹é€‰æ‹©ç­–ç•¥

### ç®€å•ä»»åŠ¡
```
ä¼˜å…ˆçº§: æœ¬åœ°æ¨¡å‹ > äº‘ç«¯æ¨¡å‹
æ’åºä¾æ®: speed_score (é€Ÿåº¦ä¼˜å…ˆ)
```

### ä¸­ç­‰/å¤æ‚ä»»åŠ¡
```
ä¼˜å…ˆçº§: æœ¬åœ°æ¨¡å‹ > äº‘ç«¯æ¨¡å‹
æ’åºä¾æ®: quality_score (è´¨é‡ä¼˜å…ˆ)
```

### ç‰¹æ®Šéœ€æ±‚
- **è§†è§‰ä»»åŠ¡**: åªé€‰æ‹© supports_vision = true çš„æ¨¡å‹
- **å·¥å…·è°ƒç”¨**: åªé€‰æ‹© supports_tools = true çš„æ¨¡å‹

---

## æ”¹è¿›æ•ˆæœè¯„ä¼°

### æ”¹è¿›å‰ vs æ”¹è¿›å

| åœºæ™¯ | æ”¹è¿›å‰ | æ”¹è¿›å |
|-----|-------|-------|
| **ç®€å•æ§åˆ¶** | ä½¿ç”¨é«˜è´¨é‡æ¨¡å‹ï¼ˆæ…¢ï¼‰ | ä½¿ç”¨å¿«é€Ÿæœ¬åœ°æ¨¡å‹ |
| **æˆæœ¬** | æ‰€æœ‰è¯·æ±‚ç”¨äº‘æ¨¡å‹ | ç®€å•ä»»åŠ¡ç”¨æœ¬åœ°å…è´¹æ¨¡å‹ |
| **æœ¬åœ°ä¸å¯ç”¨** | ç›´æ¥å¤±è´¥ | è‡ªåŠ¨é™çº§åˆ°äº‘æ¨¡å‹ |
| **è§†è§‰ä»»åŠ¡** | å¯èƒ½é€‰é”™æ¨¡å‹ | åªé€‰æ”¯æŒè§†è§‰çš„æ¨¡å‹ |

### æ€§èƒ½æå‡
1. **å“åº”é€Ÿåº¦** - ç®€å•ä»»åŠ¡ä½¿ç”¨å¿«é€Ÿæœ¬åœ°æ¨¡å‹
2. **æˆæœ¬é™ä½** - ä¼˜å…ˆä½¿ç”¨å…è´¹æœ¬åœ°æ¨¡å‹
3. **å¯é æ€§** - äº‘ç«¯å¤‡ç”¨ä¿è¯å¯ç”¨æ€§
4. **æ™ºèƒ½åŒ¹é…** - æ ¹æ®éœ€æ±‚é€‰æ‹©åˆé€‚æ¨¡å‹

---

## ä»£ç ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨
```rust
use edge_ai_agent::agent::model_selection::{
    ModelSelectionManager, ModelInfo, ModelType, ModelCapabilities,
};

let manager = ModelSelectionManager::new();

// è®¾ç½®é»˜è®¤æ¨¡å‹
manager.setup_default_models().await;

// ä¸ºä»»åŠ¡é€‰æ‹©æ¨¡å‹
let selection = manager
    .select_model("æ‰“å¼€å®¢å…ç¯", false, false)
    .await;

println!("æ¨èæ¨¡å‹: {}", selection.recommended_model);
println!("ç†ç”±: {}", selection.reason);

// å¦‚æœéœ€è¦é™çº§
if selection.requires_fallback {
    println!("å¤‡é€‰æ¨¡å‹: {:?}", selection.fallback_models);
}
```

### è‡ªå®šä¹‰æ¨¡å‹é…ç½®
```rust
let custom_model = ModelInfo {
    name: "my-local-model".to_string(),
    model_type: ModelType::Local,
    capabilities: ModelCapabilities {
        max_context: 4096,
        supports_tools: true,
        supports_vision: false,
        speed_score: 8,
        quality_score: 7,
        cost_score: 10,
    },
    available: true,
    last_checked: None,
};

manager.register_model(custom_model).await;
```

### è·å–ä½¿ç”¨ç»Ÿè®¡
```rust
// è®°å½•ä½¿ç”¨
manager.record_usage("qwen3-vl:2b").await;

// è·å–ç»Ÿè®¡
let stats = manager.get_usage_stats().await;
for (model, count) in stats {
    println!("{}: {} æ¬¡", model, count);
}
```

---

## é»˜è®¤æ¨¡å‹é…ç½®

### æœ¬åœ°æ¨¡å‹ï¼ˆOllamaï¼‰
| æ¨¡å‹ | é€Ÿåº¦ | è´¨é‡ | å·¥å…· | è§†è§‰ |
|-----|------|------|------|------|
| qwen3-vl:2b | 9 | 6 | âœ… | âœ… |
| llama3:8b | 7 | 7 | âœ… | âŒ |

### äº‘ç«¯æ¨¡å‹ï¼ˆå¤‡ç”¨ï¼‰
| æ¨¡å‹ | é€Ÿåº¦ | è´¨é‡ | å·¥å…· | è§†è§‰ |
|-----|------|------|------|------|
| gpt-4o-mini | 8 | 8 | âœ… | âœ… |

---

## æ½œåœ¨æ”¹è¿›æ–¹å‘

### P1 - è¿‘æœŸæ”¹è¿›
1. **åŠ¨æ€æ€§èƒ½æ£€æµ‹** - å®æ—¶æ£€æµ‹æ¨¡å‹å“åº”æ—¶é—´
2. **è‡ªåŠ¨æ¨¡å‹åˆ‡æ¢** - æ ¹æ®æ€§èƒ½è‡ªåŠ¨åˆ‡æ¢æ¨¡å‹
3. **æˆæœ¬è¿½è¸ª** - è®°å½•å„æ¨¡å‹å®é™…æˆæœ¬

### P2 - ä¸­æœŸæ”¹è¿›
1. **AB æµ‹è¯•** - å¯¹æ¯”ä¸åŒæ¨¡å‹æ•ˆæœ
2. **æ¨¡å‹é¢„çƒ­** - é¢„åŠ è½½å¸¸ç”¨æ¨¡å‹
3. **è´Ÿè½½å‡è¡¡** - å¤šå®ä¾‹è´Ÿè½½åˆ†é…

---

## æ€»ç»“

### âœ… å·²å®Œæˆ
- [x] ModelSelectionManager æ ¸å¿ƒæ¨¡å—
- [x] å•å…ƒæµ‹è¯•ï¼ˆ11ä¸ªï¼‰
- [x] ä»»åŠ¡å¤æ‚åº¦åˆ†æ
- [x] æœ¬åœ°æ¨¡å‹ä¼˜å…ˆç­–ç•¥
- [x] èƒ½åŠ›åŒ¹é…ï¼ˆå·¥å…·/è§†è§‰ï¼‰
- [x] é™çº§æ–¹æ¡ˆ
- [x] ä½¿ç”¨ç»Ÿè®¡è¿½è¸ª

### ğŸ“Š æŒ‡æ ‡
- **æµ‹è¯•è¦†ç›–ç‡**: 100%ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
- **ä»£ç è¡Œæ•°**: 650+ è¡Œ
- **ç¼–è¯‘è­¦å‘Š**: 0
- **æµ‹è¯•é€šè¿‡ç‡**: 100% (11/11)

### ğŸ¯ æ•ˆæœ
- **å“åº”é€Ÿåº¦**: æå‡ï¼ˆç®€å•ä»»åŠ¡ç”¨å¿«é€Ÿæ¨¡å‹ï¼‰
- **è¿è¥æˆæœ¬**: é™ä½ï¼ˆä¼˜å…ˆä½¿ç”¨æœ¬åœ°æ¨¡å‹ï¼‰
- **å¯ç”¨æ€§**: æå‡ï¼ˆäº‘ç«¯å¤‡ç”¨ï¼‰
