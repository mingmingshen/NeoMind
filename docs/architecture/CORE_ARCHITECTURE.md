# NeoTalk æ ¸å¿ƒæ¶æ„åˆ†æä¸é‡æ„è®¾è®¡

> **æ–‡æ¡£çŠ¶æ€**: ğŸ“‹ è®¾è®¡é˜¶æ®µ
>
> æœ¬æ–‡æ¡£æè¿° NeoTalk çš„ç›®æ ‡æ¶æ„è®¾è®¡å’Œé‡æ„æ–¹æ¡ˆã€‚å„æ¨¡å—çš„å®æ–½æ•°åº¦å‚è§ [TASKS.md](TASKS.md)ã€‚
>
> **çŠ¶æ€æ ‡è®°**:
> - âœ… å·²å®ç°
> - ğŸš§ è¿›è¡Œä¸­
> - ğŸ“‹ è®¡åˆ’ä¸­
> - â­ æ ¸å¿ƒé‡ç‚¹

---

## ä¸€ã€é¡¹ç›®æ ¸å¿ƒç†è§£

### 1.1 æ ¸å¿ƒå®šä½

**NeoTalk æ˜¯ä¸€ä¸ªå¯å¤šéƒ¨ç½²çš„è¾¹ç¼˜ AI è‡ªä¸»ç‰©è”ç½‘å¹³å°**

```
æ ¸å¿ƒç†å¿µ: è®¾å¤‡æŠ½è±¡ + äº‹ä»¶é©±åŠ¨ + LLM è‡ªä¸»å†³ç­–

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        NeoTalk: LLM ä½œä¸ºå¤§è„‘çš„æ¶æ„                          â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        æ•°æ®æºæ’ä»¶å±‚                                  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚   â”‚
â”‚  â”‚  â”‚ HASS     â”‚  â”‚ å†…ç½®MQTT â”‚  â”‚ å¤–éƒ¨MQTT â”‚  â”‚ Modbus   â”‚  ... æ›´å¤š  â”‚   â”‚
â”‚  â”‚  â”‚ Adapter  â”‚  â”‚ Broker   â”‚  â”‚ Broker   â”‚  â”‚ Adapter  â”‚            â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                â”‚                                            â”‚
â”‚                                â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        äº‹ä»¶æ€»çº¿ (Event Bus)                          â”‚   â”‚
â”‚  â”‚              æ‰€æœ‰ç»„ä»¶é€šè¿‡äº‹ä»¶è§£è€¦å’Œé€šä¿¡                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                    â”‚               â”‚               â”‚                       â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚        â”‚                           â”‚                           â”‚           â”‚
â”‚        â–¼                           â–¼                           â–¼           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  è§„åˆ™    â”‚              â”‚  å·¥ä½œæµ  â”‚              â”‚  å‘Šè­¦    â”‚         â”‚
â”‚  â”‚  å¼•æ“    â”‚              â”‚  å¼•æ“    â”‚              â”‚  ç³»ç»Ÿ    â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚        â”‚                           â”‚                           â”‚           â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                    â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        LLM å¤§è„‘ (AI Brain)                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  è‡ªä¸»èƒ½åŠ›                                                    â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ å®šæœŸæ£€ç´¢æ•°æ®å’Œåˆ†æ                                        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ æ€»ç»“ç³»ç»ŸçŠ¶æ€å’Œè¶‹åŠ¿                                        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ ä¸»åŠ¨æå‡ºå†³ç­–å»ºè®®                                          â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ æ‰§è¡Œé¢„é˜²æ€§æªæ–½                                            â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  äº¤äº’èƒ½åŠ›                                                    â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ å›ç­”ç”¨æˆ·é—®é¢˜                                              â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ æ‰§è¡Œç”¨æˆ·å‘½ä»¤                                              â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ åˆ›å»º/ç®¡ç†è‡ªåŠ¨åŒ–è§„åˆ™                                        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ è§£é‡Šç³»ç»Ÿè¡Œä¸º                                              â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  å·¥å…·é›† (å®Œæ•´å·¥å…·é“¾)                                         â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ list_devices - åˆ—å‡ºæ‰€æœ‰è®¾å¤‡                               â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ query_data - æŸ¥è¯¢æ—¶åºæ•°æ®                                 â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ control_device - æ§åˆ¶è®¾å¤‡                                 â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ list_rules/create_rule - ç®¡ç†è§„åˆ™                         â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ trigger_workflow - è§¦å‘å·¥ä½œæµ                             â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ analyze_trends - åˆ†ææ•°æ®è¶‹åŠ¿                             â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ propose_decisions - æå‡ºå†³ç­–å»ºè®®                          â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ execute_decision - æ‰§è¡Œå†³ç­–                               â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                  â”‚                                     â”‚ â”‚
â”‚  â–¼                                  â–¼                                     â–¼ â–¼
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ â”‚  å­˜å‚¨    â”‚                    â”‚  å‘½ä»¤    â”‚                          â”‚ ç”¨æˆ· â”‚
â”‚ â”‚          â”‚                    â”‚  ä¸‹å‘å±‚  â”‚                          â”‚      â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å‘½ä»¤ä¸‹å‘æ¶æ„ â­

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‘½ä»¤ä¸‹å‘ (Command Downlink)                          â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        å‘½ä»¤æº (Command Source)                       â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  ç”¨æˆ·       â”‚  â”‚  LLM        â”‚  â”‚  è§„åˆ™å¼•æ“   â”‚  â”‚  å·¥ä½œæµ     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  æ‰‹åŠ¨æ§åˆ¶   â”‚  â”‚  å·¥å…·è°ƒç”¨   â”‚  â”‚  EXECUTE    â”‚  â”‚  æ­¥éª¤       â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                  â”‚                                          â”‚
â”‚                                  â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        å‘½ä»¤é˜Ÿåˆ— (Priority Queue)                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  Critical  â†’  High  â†’  Normal  â†’  Low                      â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚  â€¢ æŒä¹…åŒ–é˜Ÿåˆ—é˜²æ­¢ä¸¢å¤±                                              â”‚   â”‚
â”‚  â”‚  â€¢ æ”¯æŒä¼˜å…ˆçº§è°ƒåº¦                                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                  â”‚                                          â”‚
â”‚                                  â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        å‘½ä»¤å¤„ç†å™¨ (Processor)                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ ä»é˜Ÿåˆ—è·å–å‘½ä»¤                                              â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ è°ƒç”¨ä¸‹è¡Œé€‚é…å™¨å‘é€                                          â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ æ›´æ–°å‘½ä»¤çŠ¶æ€                                                â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ å¤„ç†è¶…æ—¶å’Œé‡è¯•                                              â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                  â”‚                                          â”‚
â”‚                                  â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        ä¸‹è¡Œé€‚é…å™¨ (Downlink Adapter)                  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚   â”‚
â”‚  â”‚  â”‚  MQTT        â”‚  â”‚  Modbus      â”‚  â”‚  HTTP        â”‚  ...        â”‚   â”‚
â”‚  â”‚  â”‚  Downlink    â”‚  â”‚  Downlink    â”‚  â”‚  Downlink    â”‚             â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                  â”‚                                          â”‚
â”‚                                  â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        è®¾å¤‡å“åº”ç¡®è®¤                                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ è®¢é˜…å“åº” topic                                              â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ è§£ææ‰§è¡Œç»“æœ                                                â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ æ›´æ–°å‘½ä»¤çŠ¶æ€                                                â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ å‘å¸ƒ CommandExecuted äº‹ä»¶                                   â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        å‘½ä»¤çŠ¶æ€å­˜å‚¨                                   â”‚   â”‚
â”‚  â”‚  Pending â†’ Queued â†’ Sending â†’ WaitingAck â†’ Completed               â”‚   â”‚
â”‚  â”‚                              â†“                                       â”‚   â”‚
â”‚  â”‚                        Failed / Timeout / Cancelled                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å‘½ä»¤ç›¸å…³äº‹ä»¶ â­

```rust
// æ–°å¢åˆ° NeoTalkEvent

/// å‘½ä»¤å·²åˆ›å»º
CommandCreated { command_id, device_id, command_name, source, timestamp }

/// å‘½ä»¤å·²å‘é€
CommandSent { command_id, device_id, timestamp }

/// å‘½ä»¤è¶…æ—¶
CommandTimeout { command_id, device_id, timestamp }

/// å‘½ä»¤æ‰§è¡Œå®Œæˆ (åŸæœ‰ DeviceCommandResult å‡çº§)
CommandExecuted {
    command_id, device_id, command_name, source, success, error, timestamp
}
```

### 1.2 æ ¸å¿ƒè®¾è®¡åŸåˆ™

#### åŸåˆ™ 1: å¤šéƒ¨ç½²èƒ½åŠ›
ç³»ç»Ÿå¯éƒ¨ç½²åœ¨å¤šä¸ªä½ç½®ï¼š
- å®¶åº­/åŠå…¬å®¤è¾¹ç¼˜èŠ‚ç‚¹
- äº‘ç«¯é›†ä¸­ç®¡ç†
- å·¥å‚ç°åœº
- ç§»åŠ¨è®¾å¤‡

æ¯ä¸ªå®ä¾‹ç‹¬ç«‹è¿è¡Œï¼Œé€šè¿‡äº‹ä»¶æ€»çº¿åä½œã€‚

#### åŸåˆ™ 2: æ’ä»¶åŒ–æ•°æ®æº
æ‰€æœ‰å¤–éƒ¨æ•°æ®æºä»¥æ’ä»¶å½¢å¼æ¥å…¥ï¼š
- **HASS**: åªæ˜¯ä¼—å¤šæ•°æ®æºä¹‹ä¸€
- **å†…ç½® MQTT Broker**: ç”¨äºæœ¬åœ°è®¾å¤‡
- **å¤–éƒ¨ MQTT Broker**: è¿æ¥è¿œç¨‹è®¾å¤‡
- **æœªæ¥**: HTTP API, OPC-UA, LoRaWAN...

æ¯ä¸ªæ’ä»¶å®ç°ç›¸åŒçš„ `DeviceAdapter` æ¥å£ã€‚

#### åŸåˆ™ 3: MDL è®¾å¤‡æŠ½è±¡
- MDL (Machine Description Language) æ˜¯è®¾å¤‡æè¿°æ ‡å‡†
- æ‰€æœ‰è®¾å¤‡æ˜ å°„åˆ°ç»Ÿä¸€çš„ MDL æ ¼å¼
- ç³»ç»ŸçŸ¥é“è®¾å¤‡çš„èƒ½åŠ›ï¼ˆæŒ‡æ ‡ã€å‘½ä»¤ã€å‚æ•°ï¼‰

#### åŸåˆ™ 4: LLM æ·±åº¦é›†æˆ
LLM ä¸ä»…æ˜¯èŠå¤©ç•Œé¢ï¼š
- **æ•°æ®æµé›†æˆ**: LLM å¯ä»¥ç›´æ¥è®¿é—®å®æ—¶è®¾å¤‡æ•°æ®
- **ä¸šåŠ¡æµé›†æˆ**: LLM å¯ä»¥åˆ›å»º/ä¿®æ”¹è§„åˆ™å’Œå·¥ä½œæµ
- **è‡ªä¸»å†³ç­–**: LLM å¯ä»¥å®šæœŸåˆ†ææ•°æ®å¹¶ä¸»åŠ¨æå‡ºå»ºè®®
- **ç”¨æˆ·ä»£ç†**: ç”¨æˆ·é€šè¿‡ LLM ä¸ç³»ç»Ÿäº¤äº’

#### åŸåˆ™ 5: äº‹ä»¶é©±åŠ¨è§£è€¦
æ‰€æœ‰ç»„ä»¶é€šè¿‡äº‹ä»¶æ€»çº¿é€šä¿¡ï¼š
- è®¾å¤‡ â†’ äº‹ä»¶ â†’ è§„åˆ™/å·¥ä½œæµ
- è§„åˆ™/å·¥ä½œæµ â†’ äº‹ä»¶ â†’ è®¾å¤‡æ§åˆ¶
- LLM â†” äº‹ä»¶ â†” æ‰€æœ‰ç»„ä»¶

### 1.3 æ ¸å¿ƒç»„ä»¶è¯¦è§£

#### æ•°æ®æºæ’ä»¶å±‚
**ä½œç”¨**: è¿æ¥å¤–éƒ¨ä¸–ç•Œï¼Œç»Ÿä¸€æ•°æ®å…¥å£

**æ’ä»¶æ¥å£**:
```rust
pub trait DeviceAdapter: Send + Sync {
    fn name(&self) -> &str;              // æ’ä»¶åç§°
    async fn start(&self) -> Result<()>; // å¯åŠ¨æ’ä»¶
    async fn stop(&self) -> Result<()>;  // åœæ­¢æ’ä»¶
    fn subscribe(&self) -> Stream<DeviceEvent>; // äº‹ä»¶æµ
}
```

**å·²å®ç°çš„æ’ä»¶**:
- `MqttAdapter`: è®¢é˜… MQTT broker çš„è®¾å¤‡æ¶ˆæ¯
- `HttpAdapter`: HTTP API é€‚é…å™¨
- `WebhookAdapter`: Webhook é€‚é…å™¨

**~~å·²ç§»é™¤~~æ’ä»¶** (è½¬ä¸ºæ’ä»¶ç³»ç»Ÿ):
- ~~`HassAdapter`~~: ~~è®¢é˜… HASS discovery topic~~ (å·²ç§»é™¤ï¼Œå¯é€šè¿‡æ’ä»¶æ‰©å±•)
- ~~`ModbusAdapter`~~: ~~è½®è¯¢ Modbus è®¾å¤‡~~ (å·²ç§»é™¤ï¼Œå¯é€šè¿‡æ’ä»¶æ‰©å±•)

**æœªæ¥æ’ä»¶**:
- `OpcuaAdapter`: OPC-UA å·¥ä¸šåè®®
- `LorawanAdapter`: LoRaWAN ç‰©è”ç½‘åè®®

#### äº‹ä»¶æ€»çº¿
**ä½œç”¨**: ç³»ç»Ÿçš„ç¥ç»ç³»ç»Ÿï¼Œè¿æ¥æ‰€æœ‰ç»„ä»¶

**æ ¸å¿ƒäº‹ä»¶**:
- `DeviceOnline/Offline`: è®¾å¤‡ä¸Šä¸‹çº¿
- `DeviceMetric`: è®¾å¤‡æŒ‡æ ‡æ›´æ–°ï¼ˆæ ¸å¿ƒï¼ï¼‰
- `DeviceCommandResult`: å‘½ä»¤æ‰§è¡Œç»“æœ
- `RuleTriggered/Executed`: è§„åˆ™è§¦å‘/æ‰§è¡Œ
- `WorkflowTriggered/Completed`: å·¥ä½œæµè§¦å‘/å®Œæˆ
- `AlertCreated`: å‘Šè­¦åˆ›å»º
- `LlmDecision`: LLM å†³ç­–å»ºè®®ï¼ˆæ–°å¢ï¼ï¼‰
- `PeriodicReviewReady`: å®šæœŸå®¡æŸ¥è§¦å‘ï¼ˆæ–°å¢ï¼ï¼‰

#### è§„åˆ™å¼•æ“
**ä½œç”¨**: å®æ—¶å“åº”è®¾å¤‡æ•°æ®å˜åŒ–

**DSL**: `RULE "name" WHEN device.metric > threshold DO actions END`

**è®¢é˜…**: `DeviceMetric` äº‹ä»¶
**å‘å¸ƒ**: `RuleTriggered`, `DeviceCommand` äº‹ä»¶

**å…³é”®**: è‡ªåŠ¨è¯„ä¼°ï¼Œæ— éœ€è½®è¯¢

#### å·¥ä½œæµå¼•æ“
**ä½œç”¨**: ç¼–æ’å¤æ‚çš„å¤šæ­¥éª¤è‡ªåŠ¨åŒ–

**è§¦å‘å™¨**: Eventï¼ˆäº‹ä»¶ï¼‰ã€Cronï¼ˆå®šæ—¶ï¼‰ã€Manualï¼ˆæ‰‹åŠ¨ï¼‰ã€LlmDecisionï¼ˆLLM å†³ç­–ï¼‰

**æ­¥éª¤**: DeviceQueryã€Conditionã€ExecuteCommandã€SendAlertã€WasmExecute

#### LLM å¤§è„‘ï¼ˆæ ¸å¿ƒï¼ï¼‰
**ä½œç”¨**: ç³»ç»Ÿçš„æ™ºèƒ½å†³ç­–ä¸­å¿ƒ

**è¢«åŠ¨æ¨¡å¼**ï¼ˆå·²æœ‰ï¼‰:
- å›ç­”ç”¨æˆ·é—®é¢˜
- æ‰§è¡Œç”¨æˆ·å‘½ä»¤
- åˆ›å»ºè§„åˆ™å’Œå·¥ä½œæµ

**ä¸»åŠ¨æ¨¡å¼**ï¼ˆæ–°å¢ï¼ï¼‰:
- å®šæœŸæ£€ç´¢æ•°æ®ï¼ˆperiodic reviewï¼‰
- åˆ†æè¶‹åŠ¿å’Œå¼‚å¸¸
- ä¸»åŠ¨æå‡ºå†³ç­–å»ºè®®
- æ‰§è¡Œé¢„é˜²æ€§æªæ–½

**åŒå‘é›†æˆ**:
- è®¢é˜…äº‹ä»¶ â†’ è·å–å®æ—¶æ•°æ®
- å‘å¸ƒäº‹ä»¶ â†’ æ‰§è¡Œæ§åˆ¶æ“ä½œ

---

## äºŒã€å½“å‰æ¶æ„é—®é¢˜

### 2.1 æ¶æ„æ¦‚è§ˆ (å½“å‰)

```
å½“å‰æ¶æ„é—®é¢˜åˆ†æ:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       API Server                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  ServerState (ä¸Šå¸å¯¹è±¡)                               â”‚     â”‚
â”‚  â”‚  - session_manager: Arc<SessionManager>              â”‚     â”‚
â”‚  â”‚  - mqtt_device_manager: Arc<MqttDeviceManager>        â”‚     â”‚
â”‚  â”‚  - time_series_storage: Arc<TimeSeriesStorage>        â”‚     â”‚
â”‚  â”‚  - rule_engine: Arc<RuleEngine>                       â”‚     â”‚
â”‚  â”‚  - alert_manager: Arc<AlertManager>                   â”‚     â”‚
â”‚  â”‚  - workflow_engine: Arc<RwLock<Option<...>>>          â”‚     â”‚
â”‚  â”‚  - embedded_broker: Option<Arc<EmbeddedBroker>>       â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ ç›´æ¥è°ƒç”¨                       â”‚ ç›´æ¥è°ƒç”¨
        â†“                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MqttDevice   â”‚              â”‚   RuleEngine  â”‚
â”‚   Manager     â”‚â”€â”€æ•°æ®æµå‘?â”€â”€â†’â”‚   (æ— æ•°æ®æµ)  â”‚
â”‚  1417 è¡Œ      â”‚              â”‚   (ç‹¬ç«‹è¯„ä¼°)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 å…³é”®é—®é¢˜

#### é—®é¢˜ 1: æ•°æ®æµæ–­è£‚

**ç°çŠ¶**:
- `MqttDeviceManager` æ¥æ”¶è®¾å¤‡æ•°æ®
- `RuleEngine` æœ‰ `ValueProvider`ï¼Œä½†ä¸¤è€…æ²¡æœ‰è‡ªåŠ¨è¿æ¥
- è§„åˆ™å¼•æ“éœ€è¦æ‰‹åŠ¨è°ƒç”¨ `evaluate_rules()`ï¼Œä¸ä¼šè‡ªåŠ¨è¢«æ•°æ®å˜åŒ–è§¦å‘

**å½±å“**: è§„åˆ™ä¸ä¼šè‡ªåŠ¨å“åº”è®¾å¤‡æ•°æ®å˜åŒ–

#### é—®é¢˜ 2: äº‹ä»¶ç³»ç»Ÿä¸å®Œæ•´

**ç°çŠ¶**:
```rust
// crates/api/src/server.rs:25-57
pub struct DeviceStatusUpdate {  // ä»…æœ‰è¿™ä¸€ä¸ªäº‹ä»¶ç±»å‹
    pub update_type: String,
    pub device_id: String,
    pub status: Option<String>,
    pub last_seen: Option<i64>,
}
```

**ç¼ºå¤±**:
- ç»Ÿä¸€çš„äº‹ä»¶ç±»å‹å®šä¹‰
- äº‹ä»¶å‘å¸ƒè®¢é˜…æœºåˆ¶
- äº‹ä»¶æŒä¹…åŒ–
- äº‹ä»¶å›æ”¾

#### é—®é¢˜ 3: è§„åˆ™å¼•æ“ä¸è®¾å¤‡è„±èŠ‚

**ç°çŠ¶**:
```rust
// crates/rules/src/engine.rs:244-262
pub async fn evaluate_rules(&self) -> Vec<RuleId> {
    // ä» ValueProvider è·å–å€¼
    if let Some(value) = self.value_provider.get_value(&rule.condition.device_id, &rule.condition.metric) {
        if rule.should_trigger(value) {
            triggered.push(id.clone());
        }
    }
}
```

**é—®é¢˜**:
- è§„åˆ™å¼•æ“ä¸çŸ¥é“ä½•æ—¶æœ‰æ–°æ•°æ®åˆ°è¾¾
- éœ€è¦å¤–éƒ¨å®šæœŸè°ƒç”¨ `evaluate_rules()`
- æ²¡æœ‰ä¸è®¾å¤‡æ•°æ®æµé›†æˆ

#### é—®é¢˜ 4: å·¥ä½œæµä¸è®¾å¤‡/è§„åˆ™æ— é›†æˆ

**ç°çŠ¶**:
- å·¥ä½œæµå¯ä»¥å®šä¹‰ `DeviceQuery` å’Œ `ExecuteCommand` æ­¥éª¤
- ä½†æ²¡æœ‰è‡ªåŠ¨è§¦å‘æœºåˆ¶
- Event è§¦å‘å™¨æ²¡æœ‰å®ç°

#### é—®é¢˜ 5: LLM å·¥å…·è°ƒç”¨ä¸æ ¸å¿ƒç³»ç»Ÿéš”ç¦»

**ç°çŠ¶**:
- LLM å¯ä»¥è°ƒç”¨å·¥å…· (list_devices, query_data, control_device)
- ä½†å·¥å…·è¿”å›çš„æ˜¯ Mock æ•°æ®
- æ²¡æœ‰ä¸çœŸå®ç³»ç»Ÿè¿æ¥

#### é—®é¢˜ 6: HASS è¢«è¿‡åº¦å…³æ³¨

**ç°çŠ¶**:
- å¤§é‡ä»£ç ä¸ HASS ç›¸å…³
- HASS åªæ˜¯ä¼—å¤šæ•°æ®æºä¹‹ä¸€
- åº”è¯¥ç»Ÿä¸€ä¸º"è®¾å¤‡é€‚é…å™¨"æ¨¡å¼

#### é—®é¢˜ 7: LLM æœªè¢«ç”¨ä½œ"å¤§è„‘"

**ç°çŠ¶**:
- LLM åªæ˜¯è¢«åŠ¨å“åº”èŠå¤©
- æ²¡æœ‰ä¸»åŠ¨åˆ†ææ•°æ®çš„èƒ½åŠ›
- æ²¡æœ‰å®šæœŸå®¡æŸ¥æœºåˆ¶
- æ²¡æœ‰è‡ªä¸»å†³ç­–èƒ½åŠ›

---

## ä¸‰ã€ç›®æ ‡æ¶æ„è®¾è®¡

### 3.1 LLM ä¸­å¿ƒæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        NeoTalk: LLM ä½œä¸ºå¤§è„‘                                â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    æ•°æ®æºæ’ä»¶å±‚ (å¯æ’æ‹”)                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚   â”‚
â”‚  â”‚  â”‚   HASS   â”‚  â”‚MQTT Brokerâ”‚  â”‚  Modbus  â”‚  â”‚   HTTP   â”‚  ...      â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                â”‚ å‘å¸ƒ DeviceMetric                          â”‚
â”‚                                â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        äº‹ä»¶æ€»çº¿ (Event Bus)                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                    â”‚                    â”‚                       â”‚
â”‚         â–¼                    â–¼                    â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  è§„åˆ™å¼•æ“  â”‚      â”‚  å·¥ä½œæµ    â”‚      â”‚  å‘Šè­¦ç³»ç»Ÿ  â”‚                 â”‚
â”‚  â”‚            â”‚      â”‚  å¼•æ“      â”‚      â”‚            â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚         â”‚                    â”‚                    â”‚                       â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                              â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        LLM å¤§è„‘                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  è¢«åŠ¨äº¤äº’å±‚ (ç”¨æˆ·é©±åŠ¨)                                       â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  - å¤„ç†ç”¨æˆ·èŠå¤©æ¶ˆæ¯                                          â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  - æ‰§è¡Œç”¨æˆ·å‘½ä»¤                                              â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  - å›ç­”ç”¨æˆ·é—®é¢˜                                              â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  ä¸»åŠ¨åˆ†æå±‚ (å®šæ—¶é©±åŠ¨)                                       â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  - PeriodicReviewTrigger (æ¯Nå°æ—¶/å¤©)                       â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  - æ£€ç´¢è®¾å¤‡æ•°æ®                                              â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  - åˆ†æè¶‹åŠ¿å’Œå¼‚å¸¸                                            â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  - ç”Ÿæˆå†³ç­–å»ºè®®                                              â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  å·¥å…·é›† (è¿æ¥çœŸå®ç³»ç»Ÿ)                                       â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  - è®¾å¤‡: list_devices, query_data, control_device           â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  - è§„åˆ™: list_rules, create_rule, enable/disable_rule       â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  - å·¥ä½œæµ: list_workflows, trigger_workflow                  â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  - åˆ†æ: analyze_trends, detect_anomalies                    â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  - å†³ç­–: propose_decision, execute_decision                  â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                             â”‚                                 â”‚
â”‚           â–¼                             â–¼                                 â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚    â”‚  å­˜å‚¨    â”‚                   â”‚  ç”¨æˆ·    â”‚                           â”‚
â”‚    â”‚          â”‚                   â”‚  é€šçŸ¥    â”‚                           â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ç»Ÿä¸€äº‹ä»¶ç±»å‹

```rust
// crates/core/src/event.rs

/// ç»Ÿä¸€çš„äº‹ä»¶ç±»å‹
#[derive(Debug, Clone, Serialize, Deserialize)]
#[serde(tag = "type")]
pub enum NeoTalkEvent {
    // ========== è®¾å¤‡äº‹ä»¶ ==========
    /// è®¾å¤‡ä¸Šçº¿
    DeviceOnline {
        device_id: String,
        device_type: String,
        timestamp: i64,
    },

    /// è®¾å¤‡ç¦»çº¿
    DeviceOffline {
        device_id: String,
        reason: Option<String>,
        timestamp: i64,
    },

    /// è®¾å¤‡æŒ‡æ ‡æ›´æ–° (æ ¸å¿ƒäº‹ä»¶!)
    DeviceMetric {
        device_id: String,
        metric: String,
        value: MetricValue,
        timestamp: i64,
        quality: Option<f32>,
    },

    /// è®¾å¤‡å‘½ä»¤å®Œæˆ
    DeviceCommandResult {
        device_id: String,
        command: String,
        success: bool,
        result: Option<serde_json::Value>,
        timestamp: i64,
    },

    // ========== è§„åˆ™äº‹ä»¶ ==========
    /// è§„åˆ™æ¡ä»¶è¯„ä¼°
    RuleEvaluated {
        rule_id: String,
        rule_name: String,
        condition_met: bool,
        timestamp: i64,
    },

    /// è§„åˆ™è§¦å‘
    RuleTriggered {
        rule_id: String,
        rule_name: String,
        trigger_value: f64,
        actions: Vec<String>,
        timestamp: i64,
    },

    /// è§„åˆ™æ‰§è¡Œå®Œæˆ
    RuleExecuted {
        rule_id: String,
        rule_name: String,
        success: bool,
        duration_ms: u64,
        timestamp: i64,
    },

    // ========== å·¥ä½œæµäº‹ä»¶ ==========
    /// å·¥ä½œæµè§¦å‘
    WorkflowTriggered {
        workflow_id: String,
        trigger_type: String,  // "event", "cron", "manual", "llm_decision"
        trigger_data: Option<serde_json::Value>,
        execution_id: String,
        timestamp: i64,
    },

    /// å·¥ä½œæµæ­¥éª¤å®Œæˆ
    WorkflowStepCompleted {
        workflow_id: String,
        execution_id: String,
        step_id: String,
        result: serde_json::Value,
        timestamp: i64,
    },

    /// å·¥ä½œæµå®Œæˆ
    WorkflowCompleted {
        workflow_id: String,
        execution_id: String,
        success: bool,
        duration_ms: u64,
        timestamp: i64,
    },

    // ========== å‘Šè­¦äº‹ä»¶ ==========
    /// å‘Šè­¦åˆ›å»º
    AlertCreated {
        alert_id: String,
        title: String,
        severity: String,
        message: String,
        timestamp: i64,
    },

    /// å‘Šè­¦ç¡®è®¤
    AlertAcknowledged {
        alert_id: String,
        acknowledged_by: String,
        timestamp: i64,
    },

    // ========== LLM äº‹ä»¶ (æ–°å¢!) ==========
    /// å®šæœŸå®¡æŸ¥è§¦å‘
    PeriodicReviewTriggered {
        review_id: String,
        review_type: String,  // "hourly", "daily", "weekly"
        timestamp: i64,
    },

    /// LLM å†³ç­–å»ºè®®
    LlmDecisionProposed {
        decision_id: String,
        title: String,
        description: String,
        reasoning: String,
        actions: Vec<ProposedAction>,
        confidence: f32,
        timestamp: i64,
    },

    /// LLM å†³ç­–æ‰§è¡Œ
    LlmDecisionExecuted {
        decision_id: String,
        success: bool,
        result: Option<serde_json::Value>,
        timestamp: i64,
    },

    // ========== ç”¨æˆ·äº‹ä»¶ ==========
    /// ç”¨æˆ·æ¶ˆæ¯ (LLM)
    UserMessage {
        session_id: String,
        content: String,
        timestamp: i64,
    },

    /// LLM å“åº”äº‹ä»¶
    LlmResponse {
        session_id: String,
        content: String,
        tools_used: Vec<String>,
        processing_time_ms: u64,
        timestamp: i64,
    },
}

/// æè®®çš„å†³ç­–åŠ¨ä½œ
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ProposedAction {
    pub action_type: String,  // "control_device", "create_rule", "notify_user"
    pub description: String,
    pub parameters: serde_json::Value,
}

/// äº‹ä»¶å…ƒæ•°æ®
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct EventMetadata {
    pub event_id: String,
    pub correlation_id: Option<String>,
    pub causation_id: Option<String>,  // å› æœå…³ç³»é“¾
    pub source: String,                // äº‹ä»¶æº
    pub timestamp: i64,
}
```

### 3.3 äº‹ä»¶æ€»çº¿å®ç°

```rust
// crates/core/src/eventbus.rs

use tokio::sync::broadcast;
use std::sync::Arc;
use crate::event::NeoTalkEvent;

/// äº‹ä»¶æ€»çº¿
pub struct EventBus {
    /// å¹¿æ’­é€šé“
    tx: broadcast::Sender<(NeoTalkEvent, EventMetadata)>,
}

impl EventBus {
    pub fn new(capacity: usize) -> Self {
        let (tx, _) = broadcast::channel(capacity);
        Self { tx }
    }

    /// å‘å¸ƒäº‹ä»¶
    pub async fn publish(&self, event: NeoTalkEvent) {
        let metadata = EventMetadata {
            event_id: uuid::Uuid::new_v4().to_string(),
            correlation_id: None,
            causation_id: None,
            source: "system".to_string(),
            timestamp: chrono::Utc::now().timestamp(),
        };

        let _ = self.tx.send((event, metadata));
    }

    /// è®¢é˜…æ‰€æœ‰äº‹ä»¶
    pub fn subscribe(&self) -> broadcast::Receiver<(NeoTalkEvent, EventMetadata)> {
        self.tx.subscribe()
    }

    /// é€‰æ‹©æ€§è®¢é˜… (é€šè¿‡è¿‡æ»¤å™¨)
    pub async fn subscribe_filtered<F>(&self, filter: F) -> Subscription
    where
        F: Fn(&NeoTalkEvent) -> bool + Send + 'static,
    {
        let rx = self.subscribe();
        Subscription::new(rx, filter)
    }
}

/// é€‰æ‹©æ€§è®¢é˜…
pub struct Subscription {
    rx: broadcast::Receiver<(NeoTalkEvent, EventMetadata)>,
    filter: Box<dyn Fn(&NeoTalkEvent) -> bool + Send>,
}

impl Subscription {
    fn new<F>(rx: broadcast::Receiver<(NeoTalkEvent, EventMetadata)>, filter: F) -> Self
    where
        F: Fn(&NeoTalkEvent) -> bool + Send + 'static,
    {
        Self {
            rx,
            filter: Box::new(filter),
        }
    }

    pub async fn recv(&mut self) -> Option<(NeoTalkEvent, EventMetadata)> {
        loop {
            match self.rx.recv().await {
                Ok((event, meta)) => {
                    if (self.filter)(&event) {
                        return Some((event, meta));
                    }
                }
                Err(_) => return None,
            }
        }
    }
}
```

### 3.4 æ•°æ®æºé€‚é…å™¨æ¨¡å¼

```rust
// crates/devices/src/adapter.rs

/// è®¾å¤‡æ•°æ®æºé€‚é…å™¨
#[async_trait]
pub trait DeviceAdapter: Send + Sync {
    /// é€‚é…å™¨åç§°
    fn name(&self) -> &str;

    /// å¯åŠ¨é€‚é…å™¨
    async fn start(&self) -> Result<(), DeviceError>;

    /// åœæ­¢é€‚é…å™¨
    async fn stop(&self) -> Result<(), DeviceError>;

    /// è®¢é˜…è®¾å¤‡æ•°æ®ï¼Œè¿”å›äº‹ä»¶æµ
    fn subscribe(&self) -> Pin<Box<dyn Stream<Item = DeviceEvent> + Send>>;
}

/// è®¾å¤‡äº‹ä»¶
#[derive(Debug, Clone)]
pub enum DeviceEvent {
    Metric {
        device_id: String,
        metric: String,
        value: MetricValue,
        timestamp: i64,
    },
    State {
        device_id: String,
        old_state: DeviceState,
        new_state: DeviceState,
    },
    Discovery {
        device: DiscoveredDevice,
    },
}

/// MQTT è®¾å¤‡é€‚é…å™¨
pub struct MqttAdapter {
    config: MqttConfig,
    event_tx: broadcast::Sender<NeoTalkEvent>,
}

/// ~~HASS è®¾å¤‡é€‚é…å™¨~~ (å·²ç§»é™¤ï¼Œè½¬ä¸ºæ’ä»¶ç³»ç»Ÿ)
/// pub struct HassAdapter {
///     broker: String,
///     port: u16,
///     event_tx: broadcast::Sender<NeoTalkEvent>,
/// }

/// ~~Modbus è®¾å¤‡é€‚é…å™¨~~ (å·²ç§»é™¤ï¼Œè½¬ä¸ºæ’ä»¶ç³»ç»Ÿ)
/// pub struct ModbusAdapter {
///     devices: Vec<ModbusDeviceConfig>,
///     event_tx: broadcast::Sender<NeoTalkEvent>,
/// }

/// HTTP API è®¾å¤‡é€‚é…å™¨
pub struct HttpAdapter {
    endpoints: Vec<HttpEndpointConfig>,
    event_tx: broadcast::Sender<NeoTalkEvent>,
}
```

### 3.5 è§„åˆ™å¼•æ“é›†æˆ

```rust
// crates/rules/src/integration.rs

/// äº‹ä»¶é©±åŠ¨çš„è§„åˆ™å¼•æ“
pub struct EventDrivenRuleEngine {
    inner: RuleEngine,
    event_rx: broadcast::Receiver<(NeoTalkEvent, EventMetadata)>,
    event_tx: broadcast::Sender<NeoTalkEvent>,
}

impl EventDrivenRuleEngine {
    pub fn new(
        value_provider: Arc<dyn ValueProvider>,
        event_bus: &EventBus,
    ) -> Self {
        let rx = event_bus.subscribe();
        let tx = event_bus.sender();

        let engine = Self {
            inner: RuleEngine::new(value_provider),
            event_rx: rx,
            event_tx: tx,
        };

        // å¯åŠ¨äº‹ä»¶å¤„ç†å¾ªç¯
        tokio::spawn(engine.run());

        engine
    }

    /// äº‹ä»¶å¤„ç†å¾ªç¯
    async fn run(mut self) {
        loop {
            match self.event_rx.recv().await {
                Ok((event, metadata)) => {
                    self.handle_event(event).await;
                }
                Err(broadcast::error::RecvError::Lagged(count)) => {
                    tracing::warn!("Rule engine lagged behind by {} events", count);
                }
                Err(broadcast::error::RecvError::Closed) => {
                    tracing::error!("Event bus closed, rule engine stopping");
                    break;
                }
            }
        }
    }

    /// å¤„ç†å•ä¸ªäº‹ä»¶
    async fn handle_event(&self, event: NeoTalkEvent) {
        match event {
            // è®¾å¤‡æŒ‡æ ‡æ›´æ–° â†’ è¯„ä¼°ç›¸å…³è§„åˆ™
            NeoTalkEvent::DeviceMetric { device_id, metric, value, timestamp } => {
                self.evaluate_metric_rules(&device_id, &metric, &value, timestamp).await;
            }

            // è®¾å¤‡çŠ¶æ€å˜åŒ– â†’ è¯„ä¼°ç›¸å…³è§„åˆ™
            NeoTalkEvent::DeviceOnline { device_id, .. } => {
                self.evaluate_device_rules(&device_id).await;
            }

            _ => {}
        }
    }

    /// è¯„ä¼°ä¸è¯¥è®¾å¤‡æŒ‡æ ‡ç›¸å…³çš„è§„åˆ™
    async fn evaluate_metric_rules(
        &self,
        device_id: &str,
        metric: &str,
        value: &MetricValue,
        timestamp: i64,
    ) {
        let rules = self.inner.list_rules().await;

        for rule in rules {
            // æ£€æŸ¥è§„åˆ™æ˜¯å¦åŒ¹é…è¿™ä¸ªè®¾å¤‡çš„è¿™ä¸ªæŒ‡æ ‡
            if rule.condition.device_id == device_id && rule.condition.metric == metric {
                let numeric_value = match value {
                    MetricValue::Float(v) => *v,
                    MetricValue::Integer(v) => *v as f64,
                    _ => continue,
                };

                // è¯„ä¼°è§„åˆ™
                if rule.should_trigger(numeric_value) {
                    // è§¦å‘è§„åˆ™
                    self.trigger_rule(&rule.id, numeric_value, timestamp).await;
                }
            }
        }
    }

    /// è§¦å‘è§„åˆ™
    async fn trigger_rule(&self, rule_id: &RuleId, value: f64, timestamp: i64) {
        let result = self.inner.execute_rule(rule_id).await;

        // å‘å¸ƒè§„åˆ™è§¦å‘äº‹ä»¶
        let _ = self.event_tx.send(NeoTalkEvent::RuleTriggered {
            rule_id: rule_id.0.to_string(),
            rule_name: result.rule_name.clone(),
            trigger_value: value,
            actions: result.actions_executed,
            timestamp,
        });
    }
}
```

### 3.6 LLM å·¥å…·é›†æˆ

```rust
// crates/agent/src/tools_integration.rs

/// çœŸå®çš„å·¥å…·æ³¨å†Œè¡¨ (è¿æ¥çœŸå®ç³»ç»Ÿ)
pub struct RealToolRegistry {
    device_manager: Arc<MqttDeviceManager>,
    rule_engine: Arc<RuleEngine>,
    telemetry_store: Arc<TimeSeriesStorage>,
    workflow_engine: Arc<WorkflowEngine>,
}

impl RealToolRegistry {
    pub fn new(
        device_manager: Arc<MqttDeviceManager>,
        rule_engine: Arc<RuleEngine>,
        telemetry_store: Arc<TimeSeriesStorage>,
        workflow_engine: Arc<WorkflowEngine>,
    ) -> Self {
        Self {
            device_manager,
            rule_engine,
            telemetry_store,
            workflow_engine,
        }
    }

    /// æ‰§è¡Œå·¥å…·
    pub async fn execute_tool(&self, name: &str, args: serde_json::Value) -> Result<ToolOutput> {
        match name {
            "list_devices" => {
                let devices = self.device_manager.list_devices().await;
                Ok(ToolOutput::success(serde_json::json!({ "devices": devices })))
            }

            "query_data" => {
                let device_id = args["device_id"].as_str().ok_or("missing device_id")?;
                let metric = args["metric"].as_str().ok_or("missing metric")?;
                let value = self.device_manager.read_metric(device_id, metric).await?;
                Ok(ToolOutput::success(serde_json::json!({ "value": value_to_json(&value) })))
            }

            "control_device" => {
                let device_id = args["device_id"].as_str().ok_or("missing device_id")?;
                let command = args["command"].as_str().ok_or("missing command")?;
                let result = self.device_manager.send_command(device_id, command, args).await?;
                Ok(ToolOutput::success(serde_json::json!({ "result": result })))
            }

            "list_rules" => {
                let rules = self.rule_engine.list_rules().await;
                Ok(ToolOutput::success(serde_json::json!({ "rules": rules })))
            }

            "create_rule" => {
                let dsl = args["dsl"].as_str().ok_or("missing dsl")?;
                let rule_id = self.rule_engine.add_rule_from_dsl(dsl).await?;
                Ok(ToolOutput::success(serde_json::json!({ "rule_id": rule_id.to_string() })))
            }

            _ => Err(ToolError::NotFound(name.to_string())),
        }
    }
}
```

### 3.7 LLM ä¸»åŠ¨å†³ç­–èƒ½åŠ› (æ–°å¢ï¼)

```rust
// crates/agent/src/autonomous.rs

/// LLM è‡ªä¸»å†³ç­–ç³»ç»Ÿ
pub struct AutonomousAgent {
    agent: Arc<Agent>,
    event_bus: Arc<EventBus>,
    telemetry_store: Arc<TimeSeriesStorage>,
    config: AutonomousConfig,
}

#[derive(Debug, Clone)]
pub struct AutonomousConfig {
    /// å®šæœŸå®¡æŸ¥é—´éš” (ç§’)
    pub review_interval_secs: u64,

    /// å®¡æŸ¥ç±»å‹
    pub review_types: Vec<ReviewType>,
}

#[derive(Debug, Clone)]
pub enum ReviewType {
    /// è®¾å¤‡çŠ¶æ€å®¡æŸ¥
    DeviceHealth,

    /// è¶‹åŠ¿åˆ†æ
    TrendAnalysis,

    /// å¼‚å¸¸æ£€æµ‹
    AnomalyDetection,

    /// èƒ½è€—ä¼˜åŒ–
    EnergyOptimization,
}

impl AutonomousAgent {
    pub fn new(
        agent: Arc<Agent>,
        event_bus: Arc<EventBus>,
        telemetry_store: Arc<TimeSeriesStorage>,
        config: AutonomousConfig,
    ) -> Self {
        Self {
            agent,
            event_bus,
            telemetry_store,
            config,
        }
    }

    /// å¯åŠ¨è‡ªä¸»å†³ç­–å¾ªç¯
    pub fn start(self: Arc<Self>) {
        tokio::spawn(async move {
            let mut interval = tokio::time::interval(
                tokio::time::Duration::from_secs(self.config.review_interval_secs)
            );

            loop {
                interval.tick().await;
                self.run_review_cycle().await;
            }
        });
    }

    /// è¿è¡Œä¸€æ¬¡å®¡æŸ¥å‘¨æœŸ
    async fn run_review_cycle(&self) {
        tracing::info!("Starting autonomous review cycle");

        // å‘å¸ƒå®¡æŸ¥è§¦å‘äº‹ä»¶
        let review_id = uuid::Uuid::new_v4().to_string();
        self.event_bus.publish(NeoTalkEvent::PeriodicReviewTriggered {
            review_id: review_id.clone(),
            review_type: "full".to_string(),
            timestamp: chrono::Utc::now().timestamp(),
        }).await;

        // æ”¶é›†æ•°æ®
        let context = self.collect_context().await;

        // è®© LLM åˆ†æå¹¶æä¾›å»ºè®®
        let prompt = format!(
            "ä½ æ˜¯ç³»ç»Ÿçš„æ™ºèƒ½å¤§è„‘ã€‚è¯·åˆ†æå½“å‰ç³»ç»ŸçŠ¶æ€å¹¶æå‡ºå†³ç­–å»ºè®®ã€‚\n\n\
            å½“å‰çŠ¶æ€:\n\
            - åœ¨çº¿è®¾å¤‡: {}\n\
            - ç¦»çº¿è®¾å¤‡: {}\n\
            - æ´»è·ƒè§„åˆ™: {}\n\
            - ä»Šæ—¥å‘Šè­¦: {}\n\n\
            è¯·åˆ†æ:\n\
            1. æ˜¯å¦æœ‰å¼‚å¸¸æƒ…å†µ?\n\
            2. æ˜¯å¦æœ‰ä¼˜åŒ–ç©ºé—´?\n\
            3. æ˜¯å¦éœ€è¦åˆ›å»ºæ–°çš„è‡ªåŠ¨åŒ–è§„åˆ™?\n\n\
            ä»¥JSONæ ¼å¼è¿”å›ä½ çš„å†³ç­–å»ºè®®ã€‚",
            context.online_devices,
            context.offline_devices,
            context.active_rules,
            context.today_alerts
        );

        // è°ƒç”¨ LLM
        match self.agent.think(&prompt).await {
            Ok(decisions) => {
                // å¤„ç†å†³ç­–å»ºè®®
                for decision in decisions {
                    self.handle_decision(decision).await;
                }
            }
            Err(e) => {
                tracing::error!("Autonomous review failed: {}", e);
            }
        }
    }

    /// æ”¶é›†ç³»ç»Ÿä¸Šä¸‹æ–‡
    async fn collect_context(&self) -> SystemContext {
        // æŸ¥è¯¢è®¾å¤‡çŠ¶æ€ã€è§„åˆ™çŠ¶æ€ã€å‘Šè­¦ç­‰
        // ...
    }

    /// å¤„ç†å†³ç­–å»ºè®®
    async fn handle_decision(&self, decision: Decision) {
        // 1. å‘å¸ƒ LlmDecisionProposed äº‹ä»¶
        self.event_bus.publish(NeoTalkEvent::LlmDecisionProposed {
            decision_id: decision.id.clone(),
            title: decision.title.clone(),
            description: decision.description.clone(),
            reasoning: decision.reasoning.clone(),
            actions: decision.actions.clone(),
            confidence: decision.confidence,
            timestamp: chrono::Utc::now().timestamp(),
        }).await;

        // 2. å¦‚æœç½®ä¿¡åº¦é«˜ä¸”ä¸éœ€è¦ç”¨æˆ·ç¡®è®¤ï¼Œè‡ªåŠ¨æ‰§è¡Œ
        if decision.confidence > 0.8 && decision.auto_execute {
            for action in decision.actions {
                self.execute_action(&action).await;
            }
        }
    }

    /// æ‰§è¡Œå†³ç­–åŠ¨ä½œ
    async fn execute_action(&self, action: &ProposedAction) {
        match action.action_type.as_str() {
            "control_device" => {
                // æ§åˆ¶è®¾å¤‡
            }
            "create_rule" => {
                // åˆ›å»ºè§„åˆ™
            }
            "notify_user" => {
                // é€šçŸ¥ç”¨æˆ·
            }
            _ => {}
        }
    }
}
```

### 3.8 MDL/DSL ä½œä¸º LLM çŸ¥è¯†åº“ (æ–°å¢ï¼)

**æ ¸å¿ƒç†å¿µ**: MDL å’Œ DSL ä¸ä»…æ˜¯é…ç½®æ ¼å¼ï¼Œæ›´æ˜¯ LLM ç†è§£è®¾å¤‡å’Œè§„åˆ™çš„æ ¸å¿ƒçŸ¥è¯†åº“ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LLM çŸ¥è¯†åº“æ¶æ„                                            â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚   â”‚   MDL çŸ¥è¯†åº“    â”‚         â”‚   DSL çŸ¥è¯†åº“    â”‚                           â”‚
â”‚   â”‚  (è®¾å¤‡ç†è§£)     â”‚         â”‚  (è§„åˆ™ç†è§£)     â”‚                           â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
â”‚   â”‚ â€¢ è®¾å¤‡ç±»å‹      â”‚         â”‚ â€¢ è§„åˆ™å®šä¹‰      â”‚                           â”‚
â”‚   â”‚ â€¢ èƒ½åŠ›æè¿°      â”‚         â”‚ â€¢ è§¦å‘æ¡ä»¶      â”‚                           â”‚
â”‚   â”‚ â€¢ æŒ‡æ ‡å®šä¹‰      â”‚         â”‚ â€¢ æ‰§è¡ŒåŠ¨ä½œ      â”‚                           â”‚
â”‚   â”‚ â€¢ å‘½ä»¤æ¥å£      â”‚         â”‚ â€¢ çº¦æŸæ¡ä»¶      â”‚                           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚            â”‚                           â”‚                                     â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚                        â–¼                                                   â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚           â”‚   åŒå‘ç¿»è¯‘å±‚            â”‚                                       â”‚
â”‚           â”‚ NL â‡„ MDL, NL â‡„ DSL     â”‚                                       â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚                       â”‚                                                    â”‚
â”‚                       â–¼                                                    â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚           â”‚      LLM Tools          â”‚                                       â”‚
â”‚           â”‚  â€¢ list_device_types    â”‚                                       â”‚
â”‚           â”‚  â€¢ get_device_type      â”‚                                       â”‚
â”‚           â”‚  â€¢ explain_device       â”‚                                       â”‚
â”‚           â”‚  â€¢ list_rules           â”‚                                       â”‚
â”‚           â”‚  â€¢ get_rule             â”‚                                       â”‚
â”‚           â”‚  â€¢ explain_rule         â”‚                                       â”‚
â”‚           â”‚  â€¢ generate_rule_dsl    â”‚                                       â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### MDL ä¸º LLM æä¾›è®¾å¤‡ç†è§£

```rust
/// LLM æŸ¥è¯¢è®¾å¤‡ç±»å‹çš„å·¥å…·
impl Tool for ListDeviceTypes {
    fn name(&self) -> &str { "list_device_types" }
    fn description(&self) -> &str { "æŸ¥è¯¢ç³»ç»Ÿä¸­æ‰€æœ‰å¯ç”¨çš„è®¾å¤‡ç±»å‹" }

    async fn execute(&self, args: Value) -> ToolResult {
        let types = MdlRegistry::global().list_types();
        Ok(json!({ "device_types": types }))
    }
}

impl Tool for GetDeviceType {
    fn name(&self) -> &str { "get_device_type" }
    fn description(&self) -> &str { "è·å–æŒ‡å®šè®¾å¤‡ç±»å‹çš„å®Œæ•´å®šä¹‰" }

    async fn execute(&self, args: Value) -> ToolResult {
        let type_id = args["type_id"].as_str()?;
        let definition = MdlRegistry::global().get_definition(type_id)?;
        Ok(json!(definition))  // åŒ…å« uplink æŒ‡æ ‡ã€downlink å‘½ä»¤
    }
}

impl Tool for ExplainDeviceType {
    fn name(&self) -> &str { "explain_device_type" }
    fn description(&self) -> &str { "ç”¨è‡ªç„¶è¯­è¨€è§£é‡Šè®¾å¤‡ç±»å‹åŠŸèƒ½" }

    async fn execute(&self, args: Value) -> ToolResult {
        let def = get_device_type(&args["type_id"])?;
        // å°† MDL è½¬æ¢ä¸ºè‡ªç„¶è¯­è¨€æè¿°
        let explanation = mdl_to_natural_language(&def, "zh");
        Ok(json!({ "explanation": explanation }))
    }
}
```

#### DSL ä¸º LLM æä¾›è§„åˆ™ç†è§£

```rust
/// LLM æŸ¥è¯¢è§„åˆ™çš„å·¥å…·
impl Tool for ListRules {
    fn name(&self) -> &str { "list_rules" }
    fn description(&self) -> &str { "åˆ—å‡ºç³»ç»Ÿä¸­çš„æ‰€æœ‰è§„åˆ™" }

    async fn execute(&self, args: Value) -> ToolResult {
        let rules = RuleEngine::global().list_rules();
        Ok(json!({ "rules": rules }))
    }
}

impl Tool for ExplainRule {
    fn name(&self) -> &str { "explain_rule" }
    fn description(&self) -> &str { "ç”¨è‡ªç„¶è¯­è¨€è§£é‡Šè§„åˆ™çš„å«ä¹‰" }

    async fn execute(&self, args: Value) -> ToolResult {
        let rule = RuleEngine::global().get_rule(&args["rule_id"])?;
        // å°† DSL è½¬æ¢ä¸ºè‡ªç„¶è¯­è¨€è§£é‡Š
        let explanation = dsl_to_natural_language(&rule, "zh");
        Ok(json!({ "explanation": explanation }))
    }
}

impl Tool for GenerateRuleDsl {
    fn name(&self) -> &str { "generate_rule_dsl" }
    fn description(&self) -> &str { "æ ¹æ®ç”¨æˆ·æè¿°ç”Ÿæˆè§„åˆ™ DSL" }

    async fn execute(&self, args: Value) -> ToolResult {
        let description = args["description"].as_str()?;
        // è·å–ç›¸å…³è®¾å¤‡ç±»å‹ä½œä¸ºä¸Šä¸‹æ–‡
        let device_context = extract_device_context(description);
        // è°ƒç”¨ LLM ç”Ÿæˆ DSL
        let dsl = self.llm.generate_with_context(description, device_context).await?;
        // éªŒè¯ DSL
        let validated = RuleDslParser::new().parse(&dsl)?;
        Ok(json!({ "dsl": dsl, "rule": validated }))
    }
}
```

#### æ™ºèƒ½ä¸Šä¸‹æ–‡æ³¨å…¥

```rust
/// æ ¹æ®ç”¨æˆ·æŸ¥è¯¢é€‰æ‹©ç›¸å…³ä¸Šä¸‹æ–‡
pub struct ContextSelector {
    mdl_store: Arc<MdlStore>,
    dsl_store: Arc<DslStore>,
    vector_store: Arc<VectorStore>,
}

impl ContextSelector {
    pub async fn select_context(&self, query: &str) -> ContextBundle {
        let intent = IntentAnalyzer::analyze(query);

        match intent {
            Intent::DeviceQuery => {
                // è¯­ä¹‰æœç´¢ç›¸å…³è®¾å¤‡ç±»å‹
                bundle.mdl_definitions = self.vector_store.search(query, top_k=5).await;
            }
            Intent::RuleCreation => {
                // åˆ›å»ºè§„åˆ™éœ€è¦æ‰€æœ‰è®¾å¤‡ç±»å‹å’Œç¤ºä¾‹è§„åˆ™
                bundle.mdl_definitions = self.get_all_device_types().await;
                bundle.dsl_examples = true;
            }
            // ...
        }
        bundle
    }
}
```

#### åŒå‘ç¿»è¯‘

- **MDL â†’ è‡ªç„¶è¯­è¨€**: å‘ç”¨æˆ·è§£é‡Šè®¾å¤‡èƒ½åŠ›
- **DSL â†’ è‡ªç„¶è¯­è¨€**: å‘ç”¨æˆ·è§£é‡Šè§„åˆ™é€»è¾‘
- **è‡ªç„¶è¯­è¨€ â†’ DSL**: ç”¨æˆ·æ„å›¾è½¬æ¢ä¸ºè§„åˆ™
- **è‡ªç„¶è¯­è¨€ â†’ MDL æŸ¥è¯¢**: ç”¨æˆ·é—®é¢˜è½¬æ¢ä¸ºè®¾å¤‡æŸ¥è¯¢

#### å‘é‡åŒ–å­˜å‚¨

```rust
/// ç´¢å¼• MDL å®šä¹‰ç”¨äºè¯­ä¹‰æœç´¢
pub async fn index_mdl(&self, definition: &DeviceTypeDefinition) {
    let text = format!(
        "{} {} {} {}",
        definition.name,
        definition.description,
        definition.uplink.iter().map(|m| &m.name).join(" "),
        definition.downlink.iter().map(|c| &c.name).join(" ")
    );

    let embedding = self.embed_text(&text).await;

    self.vector_store.insert(VectorDocument {
        id: definition.type_id.clone(),
        vector: embedding,
        metadata: json!({ "type": "mdl", "name": definition.name }),
        payload: json!(definition),
    }).await;
}
```

---

## å››ã€é‡æ„è®¡åˆ’

### é˜¶æ®µ 0: åŸºç¡€è®¾æ–½ (Week 1)

**ç›®æ ‡**: å»ºç«‹äº‹ä»¶é©±åŠ¨åŸºç¡€è®¾æ–½

1. **åˆ›å»ºäº‹ä»¶æ¨¡å—**
   - `crates/core/src/event.rs` - ç»Ÿä¸€äº‹ä»¶ç±»å‹å®šä¹‰ï¼ˆåŒ…æ‹¬ LLM äº‹ä»¶ï¼‰
   - `crates/core/src/eventbus.rs` - äº‹ä»¶æ€»çº¿å®ç°
   - `crates/core/src/metadata.rs` - äº‹ä»¶å…ƒæ•°æ®

2. **åˆ›å»ºé€‚é…å™¨æ¥å£**
   - `crates/devices/src/adapter.rs` - DeviceAdapter trait
   - `crates/devices/src/adapters/mod.rs` - é€‚é…å™¨æ¨¡å—

### é˜¶æ®µ 1: æ•°æ®æºæ’ä»¶åŒ– (Week 2)

**ç›®æ ‡**: å°†ç°æœ‰æ•°æ®æºé‡æ„ä¸ºæ’ä»¶

1. **MQTT é€‚é…å™¨**
   - `crates/devices/src/adapters/mqtt.rs` - MQTT é€‚é…å™¨

2. **HASS é€‚é…å™¨**
   - `crates/devices/src/adapters/hass.rs` - HASS é€‚é…å™¨ï¼ˆåªæ˜¯å…¶ä¸­ä¸€ä¸ªï¼‰

3. **é€‚é…å™¨ç®¡ç†å™¨**
   - `crates/devices/src/adapter_manager.rs` - ç®¡ç†æ‰€æœ‰é€‚é…å™¨

### é˜¶æ®µ 2: è§„åˆ™å¼•æ“äº‹ä»¶é©±åŠ¨ (Week 3)

**ç›®æ ‡**: è§„åˆ™å¼•æ“è‡ªåŠ¨å“åº”è®¾å¤‡äº‹ä»¶

1. **é‡æ„è§„åˆ™å¼•æ“**
   - åˆ›å»º `EventDrivenRuleEngine`
   - é›†æˆäº‹ä»¶è®¢é˜…
   - è‡ªåŠ¨è¯„ä¼°è§„åˆ™

2. **æ•°æ®æµé›†æˆ**
   - è®¾å¤‡æŒ‡æ ‡äº‹ä»¶ â†’ è§„åˆ™è¯„ä¼°
   - è§„åˆ™è§¦å‘ â†’ è®¾å¤‡æ§åˆ¶äº‹ä»¶

### é˜¶æ®µ 3: å·¥ä½œæµäº‹ä»¶é›†æˆ (Week 4)

**ç›®æ ‡**: å·¥ä½œæµå“åº”äº‹ä»¶è§¦å‘

1. **å·¥ä½œæµè§¦å‘å™¨**
   - å®ç° EventTrigger
   - è®¢é˜…ç‰¹å®šäº‹ä»¶æ¨¡å¼
   - è‡ªåŠ¨å¯åŠ¨å·¥ä½œæµ

2. **è®¾å¤‡é›†æˆ**
   - DeviceQuery æ­¥éª¤ä»çœŸå®è®¾å¤‡è¯»å–
   - ExecuteCommand æ­¥éª¤å‘é€çœŸå®å‘½ä»¤

### é˜¶æ®µ 4: LLM å·¥å…·é›†æˆ (Week 5)

**ç›®æ ‡**: LLM å¯ä»¥è°ƒç”¨çœŸå®ç³»ç»Ÿ

1. **çœŸå®å·¥å…·å®ç°**
   - æ›¿æ¢ Mock ä¸ºçœŸå®ç³»ç»Ÿè°ƒç”¨
   - è¿æ¥ DeviceManager, RuleEngine, WorkflowEngine

2. **åŒå‘é›†æˆ**
   - LLM å¯ä»¥è§¦å‘è§„åˆ™å’Œå·¥ä½œæµ
   - è§„åˆ™å’Œå·¥ä½œæµå¯ä»¥å‘é€é€šçŸ¥ç»™ç”¨æˆ·

### é˜¶æ®µ 5: LLM è‡ªä¸»å†³ç­– (Week 6-7) â­ æ ¸å¿ƒé˜¶æ®µ

**ç›®æ ‡**: LLM æˆä¸ºç³»ç»Ÿå¤§è„‘

1. **å®šæœŸå®¡æŸ¥æœºåˆ¶**
   - `crates/agent/src/autonomous.rs` - è‡ªä¸» Agent
   - å®šæ—¶è§¦å‘å®¡æŸ¥ï¼ˆæ¯å°æ—¶/æ¯å¤©ï¼‰
   - æ”¶é›†ç³»ç»ŸçŠ¶æ€æ•°æ®

2. **æ•°æ®åˆ†æèƒ½åŠ›**
   - è¶‹åŠ¿åˆ†æå·¥å…·
   - å¼‚å¸¸æ£€æµ‹å·¥å…·
   - èƒ½è€—åˆ†æå·¥å…·

3. **å†³ç­–å»ºè®®ç³»ç»Ÿ**
   - LLM ç”Ÿæˆå†³ç­–å»ºè®®
   - å‘å¸ƒ `LlmDecisionProposed` äº‹ä»¶
   - ç”¨æˆ·ç¡®è®¤æˆ–è‡ªåŠ¨æ‰§è¡Œ

4. **ä¸»åŠ¨ä¼˜åŒ–**
   - è‡ªåŠ¨å‘ç°ä¼˜åŒ–æœºä¼š
   - è‡ªåŠ¨åˆ›å»ºä¼˜åŒ–è§„åˆ™
   - ä¸»åŠ¨é€šçŸ¥ç”¨æˆ·

### é˜¶æ®µ 6: å‰ç«¯é‡æ„ (Week 8-9)

**ç›®æ ‡**: å‰ç«¯æ˜¾ç¤ºçœŸå®æ•°æ®å’Œ LLM å†³ç­–

1. **å®æ—¶æ•°æ®**
   - WebSocket è®¢é˜…è®¾å¤‡äº‹ä»¶
   - å®æ—¶æ˜¾ç¤ºæŒ‡æ ‡å˜åŒ–
   - å®æ—¶æ˜¾ç¤ºè§„åˆ™è§¦å‘

2. **LLM å†³ç­–ç•Œé¢**
   - æ˜¾ç¤º LLM å†³ç­–å»ºè®®
   - ç”¨æˆ·ç¡®è®¤/æ‹’ç»ç•Œé¢
   - å†³ç­–å†å²æŸ¥çœ‹

3. **æ§åˆ¶ç•Œé¢**
   - è®¾å¤‡æ§åˆ¶
   - è§„åˆ™ç®¡ç†
   - å·¥ä½œæµç›‘æ§

---

## äº”ã€æ ¸å¿ƒæ•°æ®æµ

### 5.1 è®¾å¤‡æ•°æ® â†’ è§„åˆ™ â†’ åŠ¨ä½œ

```
æ•°æ®æµ:

MQTT Device (å‘å¸ƒ metric)
    â†“
MqttAdapter (æ¥æ”¶)
    â†“
EventBus::publish(DeviceMetric { device_id: "sensor1", metric: "temperature", value: 75.0 })
    â†“
RuleEngine (è®¢é˜… DeviceMetric)
    â†“
è¯„ä¼°: WHEN sensor1.temperature > 50
    â†“
EventBus::publish(RuleTriggered { rule_id: "alert_1" })
    â†“
EventHandler (è®¢é˜… RuleTriggered)
    â†“
æ‰§è¡ŒåŠ¨ä½œ: NOTIFY "æ¸©åº¦è¿‡é«˜"
```

### 5.2 LLM â†’ è®¾å¤‡æ§åˆ¶

```
æ§åˆ¶æµ:

ç”¨æˆ·: "æ‰“å¼€å®¢å…çš„ç¯"
    â†“
LLM Agent (è§£ææ„å›¾)
    â†“
Tool Call: control_device(device_id="light_1", command="turn_on")
    â†“
RealToolRegistry::execute_tool("control_device", args)
    â†“
MqttDeviceManager::send_command("light_1", "turn_on")
    â†“
MQTT Publish: cmnd/light_1/POWER "ON"
    â†“
è®¾å¤‡æ‰§è¡Œ â†’ EventBus::publish(DeviceCommandResult)
```

### 5.3 LLM ä¸»åŠ¨å†³ç­– (æ–°å¢ï¼)

```
è‡ªä¸»å†³ç­–æµ:

å®šæ—¶è§¦å‘å™¨ (æ¯å°æ—¶)
    â†“
EventBus::publish(PeriodicReviewTriggered)
    â†“
AutonomousAgent (è®¢é˜… PeriodicReviewTriggered)
    â†“
æ”¶é›†ç³»ç»Ÿæ•°æ®:
  - è®¾å¤‡çŠ¶æ€
  - è§„åˆ™æ‰§è¡Œå†å²
  - å‘Šè­¦ç»Ÿè®¡
  - èƒ½è€—è¶‹åŠ¿
    â†“
LLM åˆ†ææ•°æ®
    â†“
ç”Ÿæˆå†³ç­–å»ºè®®:
  - "æ£€æµ‹åˆ°è®¾å¤‡ xyz æ¸©åº¦æŒç»­å‡é«˜"
  - "å»ºè®®: åˆ›å»ºè§„åˆ™ WHEN xyz.temperature > 80 DO turn_on_fan"
    â†“
EventBus::publish(LlmDecisionProposed {
  title: "é¢„é˜²æ€§é™æ¸©å»ºè®®",
  actions: [create_rule, ...],
  confidence: 0.85
})
    â†“
å‰ç«¯æ˜¾ç¤ºå†³ç­–å»ºè®®
    â†“
ç”¨æˆ·ç¡®è®¤ â†’ è‡ªåŠ¨æ‰§è¡Œ
    â†“
EventBus::publish(LlmDecisionExecuted)
```

### 5.4 ç”¨æˆ·ä¸ LLM äº¤äº’

```
ç”¨æˆ·äº¤äº’æµ:

ç”¨æˆ·: "å¸®æˆ‘æ€»ç»“ä¸€ä¸‹ä»Šå¤©çš„è®¾å¤‡çŠ¶æ€"
    â†“
LLM Agent è°ƒç”¨å·¥å…·:
  - list_devices() â†’ è·å–è®¾å¤‡åˆ—è¡¨
  - query_data(..., "last_24h") â†’ è·å–24å°æ—¶æ•°æ®
  - analyze_trends(...) â†’ åˆ†æè¶‹åŠ¿
    â†“
LLM ç”Ÿæˆæ€»ç»“:
  "ä»Šå¤©æœ‰ 15 ä¸ªè®¾å¤‡åœ¨çº¿ã€‚
   æ¸©åº¦ä¼ æ„Ÿå™¨å¹³å‡æ¸©åº¦ 25Â°Cã€‚
   æ£€æµ‹åˆ° 2 ä¸ªå¼‚å¸¸:
   - è®¾å¤‡ sensor3 åœ¨ 14:00 æ¸©åº¦å¼‚å¸¸å‡é«˜
   - è®¾å¤‡ light5 åœ¨ 10:00 ç¦»çº¿"
    â†“
LLM ä¸»åŠ¨æå‡ºå»ºè®®:
  "å»ºè®®: ä¸º sensor3 åˆ›å»ºé«˜æ¸©å‘Šè­¦è§„åˆ™"
    â†“
ç”¨æˆ·: "å¥½çš„ï¼Œåˆ›å»º"
    â†“
LLM æ‰§è¡Œ: create_rule(...)
```

---

## å…­ã€å…³é”®æ–‡ä»¶ç»“æ„

### é‡æ„åçš„ç›®å½•ç»“æ„

```
crates/
â”œâ”€â”€ core/                    # æ ¸å¿ƒç±»å‹å’Œäº‹ä»¶
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ event.rs         # ç»Ÿä¸€äº‹ä»¶ç±»å‹
â”‚   â”‚   â”œâ”€â”€ eventbus.rs      # äº‹ä»¶æ€»çº¿
â”‚   â”‚   â”œâ”€â”€ message.rs       # æ¶ˆæ¯ç±»å‹
â”‚   â”‚   â””â”€â”€ lib.rs
â”‚
â”œâ”€â”€ devices/                 # è®¾å¤‡ç®¡ç†
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ adapter.rs       # DeviceAdapter trait
â”‚   â”‚   â”œâ”€â”€ adapter_manager.rs  # é€‚é…å™¨ç®¡ç†å™¨
â”‚   â”‚   â”œâ”€â”€ adapters/        # é€‚é…å™¨å®ç°
â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ mqtt.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ hass.rs      # HASS åªæ˜¯å…¶ä¸­ä¸€ä¸ª
â”‚   â”‚   â”‚   â”œâ”€â”€ modbus.rs
â”‚   â”‚   â”‚   â””â”€â”€ http.rs
â”‚   â”‚   â”œâ”€â”€ mdl/             # è®¾å¤‡ç±»å‹å®šä¹‰
â”‚   â”‚   â””â”€â”€ telemetry.rs     # æ—¶åºå­˜å‚¨
â”‚
â”œâ”€â”€ rules/                   # è§„åˆ™å¼•æ“
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ engine.rs        # è§„åˆ™å¼•æ“
â”‚   â”‚   â”œâ”€â”€ dsl.rs           # DSL è§£æ
â”‚   â”‚   â””â”€â”€ integration.rs   # äº‹ä»¶é›†æˆ
â”‚
â”œâ”€â”€ workflow/                # å·¥ä½œæµå¼•æ“
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ workflow.rs      # å·¥ä½œæµå®šä¹‰
â”‚   â”‚   â”œâ”€â”€ executor.rs      # æ‰§è¡Œå™¨
â”‚   â”‚   â””â”€â”€ triggers/        # è§¦å‘å™¨
â”‚   â”‚       â”œâ”€â”€ event.rs     # äº‹ä»¶è§¦å‘å™¨
â”‚   â”‚       â”œâ”€â”€ cron.rs      # å®šæ—¶è§¦å‘å™¨
â”‚   â”‚       â”œâ”€â”€ manual.rs    # æ‰‹åŠ¨è§¦å‘å™¨
â”‚   â”‚       â””â”€â”€ llm_decision.rs  # LLM å†³ç­–è§¦å‘å™¨
â”‚
â”œâ”€â”€ agent/                   # LLM Agent
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ agent.rs         # Agent æ ¸å¿ƒ
â”‚   â”‚   â”œâ”€â”€ autonomous.rs    # è‡ªä¸»å†³ç­– (æ–°å¢!)
â”‚   â”‚   â”œâ”€â”€ tools/           # å·¥å…·é›†æˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ registry.rs  # å·¥å…·æ³¨å†Œè¡¨
â”‚   â”‚   â”‚   â””â”€â”€ real.rs      # çœŸå®å·¥å…·å®ç°
â”‚   â”‚   â””â”€â”€ session.rs       # ä¼šè¯ç®¡ç†
â”‚
â”œâ”€â”€ api/                     # API Server
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ handlers/        # HTTP/WebSocket handlers
â”‚   â”‚   â”œâ”€â”€ middleware/      # ä¸­é—´ä»¶
â”‚   â”‚   â””â”€â”€ server.rs        # æœåŠ¡å™¨
â”‚
â””â”€â”€ storage/                 # å­˜å‚¨
    â”œâ”€â”€ src/
    â”‚   â”œâ”€â”€ telemetry.rs     # æ—¶åºæ•°æ® (redb)
    â”‚   â”œâ”€â”€ state.rs         # çŠ¶æ€æ•°æ® (sled)
    â”‚   â”œâ”€â”€ events.rs        # äº‹ä»¶æ—¥å¿—
    â”‚   â””â”€â”€ decisions.rs     # LLM å†³ç­–å†å² (æ–°å¢!)
```

---

## ä¸ƒã€å®æ–½ä¼˜å…ˆçº§

### P0 (Critical) - äº‹ä»¶é©±åŠ¨æ ¸å¿ƒ

1. **ç»Ÿä¸€äº‹ä»¶ç±»å‹** - `crates/core/src/event.rs`
2. **äº‹ä»¶æ€»çº¿** - `crates/core/src/eventbus.rs`
3. **è®¾å¤‡é€‚é…å™¨æ¥å£** - `crates/devices/src/adapter.rs`

### P0 (Critical) - LLM å·¥å…·é›†æˆ

4. **çœŸå®å·¥å…·å®ç°** - `crates/agent/src/tools/real.rs`
5. **å·¥å…·æ³¨å†Œè¡¨** - `crates/agent/src/tools/registry.rs`

### P1 (High) - æ•°æ®æµé›†æˆ

6. **è§„åˆ™å¼•æ“äº‹ä»¶é›†æˆ** - `crates/rules/src/integration.rs`
7. **MQTT é€‚é…å™¨** - `crates/devices/src/adapters/mqtt.rs`
8. **é€‚é…å™¨ç®¡ç†å™¨** - `crates/devices/src/adapter_manager.rs`

### P1 (High) - LLM è‡ªä¸»èƒ½åŠ› â­

9. **è‡ªä¸» Agent æ¡†æ¶** - `crates/agent/src/autonomous.rs`
10. **å®šæœŸå®¡æŸ¥æœºåˆ¶** - å®šæ—¶è§¦å‘ + æ•°æ®æ”¶é›†
11. **å†³ç­–å»ºè®®ç³»ç»Ÿ** - LlmDecisionProposed äº‹ä»¶ + å¤„ç†
12. **åˆ†æå·¥å…·é›†** - è¶‹åŠ¿åˆ†æã€å¼‚å¸¸æ£€æµ‹

### P2 (Medium) - å·¥ä½œæµå’Œå‰ç«¯

13. **å·¥ä½œæµäº‹ä»¶è§¦å‘å™¨** - `crates/workflow/src/triggers/event.rs`
14. **å‰ç«¯å®æ—¶äº‹ä»¶** - WebSocket è®¢é˜…
15. **LLM å†³ç­–ç•Œé¢** - å‰ç«¯ç»„ä»¶

### P3 (Low) - ä¼˜åŒ–å’Œæ‰©å±•

16. **äº‹ä»¶æŒä¹…åŒ–**
17. **äº‹ä»¶å›æ”¾**
18. **æ€§èƒ½ç›‘æ§**

---

## å…«ã€æˆåŠŸæ ‡å‡†

### åŠŸèƒ½å®Œæ•´æ€§
- [ ] è®¾å¤‡æ•°æ®å˜åŒ–è‡ªåŠ¨è§¦å‘è§„åˆ™è¯„ä¼°
- [ ] è§„åˆ™å¯ä»¥æ§åˆ¶è®¾å¤‡
- [ ] LLM å¯ä»¥æŸ¥è¯¢è®¾å¤‡å’Œæ§åˆ¶è®¾å¤‡
- [ ] å·¥ä½œæµå¯ä»¥å“åº”è®¾å¤‡äº‹ä»¶
- [ ] å‰ç«¯å®æ—¶æ˜¾ç¤ºè®¾å¤‡çŠ¶æ€å’Œè§„åˆ™è§¦å‘
- [ ] **LLM å¯ä»¥å®šæœŸåˆ†æç³»ç»ŸçŠ¶æ€**
- [ ] **LLM å¯ä»¥ä¸»åŠ¨æå‡ºä¼˜åŒ–å»ºè®®**
- [ ] **LLM å†³ç­–å¯ä»¥è‡ªåŠ¨æ‰§è¡Œ**

### LLM èƒ½åŠ›éªŒè¯
- [ ] LLM èƒ½å›ç­”"ä»Šå¤©ç³»ç»Ÿæ€ä¹ˆæ ·"
- [ ] LLM èƒ½æ£€æµ‹å¼‚å¸¸å¹¶å‘Šè­¦
- [ ] LLM èƒ½ä¸»åŠ¨åˆ›å»ºä¼˜åŒ–è§„åˆ™
- [ ] LLM èƒ½è§£é‡Šè§„åˆ™è§¦å‘åŸå› 
- [ ] LLM èƒ½æ€»ç»“å†å²æ•°æ®è¶‹åŠ¿

### æ€§èƒ½æŒ‡æ ‡
- [ ] äº‹ä»¶å»¶è¿Ÿ < 10ms (ä»è®¾å¤‡åˆ°è§„åˆ™è¯„ä¼°)
- [ ] æ”¯æŒå¹¶å‘ 1000+ è®¾å¤‡
- [ ] è§„åˆ™è¯„ä¼°å»¶è¿Ÿ < 1ms
- [ ] LLM å“åº”æ—¶é—´ < 5s (å¤æ‚åˆ†æ)

### ä»£ç è´¨é‡
- [ ] å•ä¸€èŒè´£: æ¯ä¸ªæ–‡ä»¶ < 500 è¡Œ
- [ ] æ¾è€¦åˆ: æ¨¡å—é€šè¿‡äº‹ä»¶é€šä¿¡
- [ ] å¯æµ‹è¯•: äº‹ä»¶é©±åŠ¨æ˜“äºå•å…ƒæµ‹è¯•
