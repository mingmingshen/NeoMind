name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.2.0)'
        required: true
        default: 'v0.2.0'

env:
  CARGO_TERM_COLOR: always

jobs:
  build-macos:
    name: Build macOS DMG
    runs-on: macos-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './web/src-tauri -> target'

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './web/package-lock.json'

      - name: Install dependencies
        working-directory: ./web
        run: npm ci

      - name: Build frontend
        working-directory: ./web
        run: npm run build

      - name: Build Tauri app (unsigned)
        working-directory: ./web
        run: npx tauri build -- --bundle-format dmg

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: web/src-tauri/target/release/bundle/dmg/*.dmg
          if-no-files-found: error

  build-windows:
    name: Build Windows EXE
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './web/src-tauri -> target'

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './web/package-lock.json'

      - name: Install dependencies
        working-directory: ./web
        run: npm ci

      - name: Build frontend
        working-directory: ./web
        run: npm run build

      - name: Build Tauri app (unsigned)
        working-directory: ./web
        run: npx tauri build -- --bundle-format nsis

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: web/src-tauri/target/release/bundle/nsis/*.exe
          if-no-files-found: error

  build-linux:
    name: Build Linux AppImage/Deb
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './web/src-tauri -> target'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './web/package-lock.json'

      - name: Install dependencies
        working-directory: ./web
        run: npm ci

      - name: Build frontend
        working-directory: ./web
        run: npm run build

      - name: Build Tauri app (unsigned)
        working-directory: ./web
        run: npx tauri build -- --bundle-format appimage --bundle-format deb

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-bundles
          path: |
            web/src-tauri/target/release/bundle/appimage/*.AppImage
            web/src-tauri/target/release/bundle/deb/*.deb
          if-no-files-found: error

  release:
    name: Create Release
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Get version from tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: NeoMind ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## NeoMind ${{ steps.get_version.outputs.VERSION }}
            
            ### Download & Install
            
            **macOS (Apple Silicon/Intel)**
            - Download `NeoMind_*.dmg`
            - Open the DMG file
            - Drag NeoMind to Applications folder
            - **First launch**: Right-click NeoMind.app → select "Open"
            
            **Windows**
            - Download `NeoMind_*.exe`
            - Run the installer
            - Launch NeoMind from Start Menu
            
            **Linux (Debian/Ubuntu)**
            - Download `NeoMind_*.deb`
            - Install: `sudo apt install ./NeoMind_*.deb`
            
            **Linux (AppImage - Universal)**
            - Download `NeoMind_*.AppImage`
            - Make executable: `chmod +x NeoMind_*.AppImage`
            - Run: `./NeoMind_*.AppImage`
            
            ### First Launch (macOS)
            
            Due to macOS security restrictions for unsigned apps:
            1. Right-click NeoMind.app
            2. Hold `Option` key → select "Open"
            3. Click "Open" in the dialog
            
            Or run in Terminal:
            ```bash
            xattr -d com.apple.quarantine /Applications/NeoMind.app
            open /Applications/NeoMind.app
            ```
            
            ### Requirements
            - **macOS**: 12.0 (Monterey) or later
            - **Windows**: 10 or later
            - **Linux**: glibc 2.31+ (Ubuntu 20.04+, Debian 11+)
            
            ---
            [Full Changelog](https://github.com/mingmingshen/NeoMind/commits/${{ steps.get_version.outputs.VERSION }})
          files: |
            artifacts/macos-dmg/*.dmg
            artifacts/windows-exe/*.exe
            artifacts/linux-bundles/*.AppImage
            artifacts/linux-bundles/*.deb
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
