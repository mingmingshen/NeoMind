stages:
  - build
  - release

variables:
  CARGO_HOME: "$CI_PROJECT_DIR/.cargo"
  NPM_CONFIG_CACHE: "$CI_PROJECT_DIR/.npm"

build-macos:
  stage: build
  tags:
    - saas-macos-medium-arm64
  script:
    - cd web
    - npm ci
    - npm run build
    - cargo install tauri-cli --version "^2.0"
    - cargo tauri build --target aarch64-apple-darwin --bundles dmg
  artifacts:
    paths:
      - web/src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg
    expire_in: 1 week
  only:
    - tags

build-windows:
  stage: build
  tags:
    - saas-windows-medium-amd64
  script:
    - cd web
    - npm ci
    - npm run build
    - cargo install tauri-cli --version "^2.0"
    - cargo tauri build --bundles msi
  artifacts:
    paths:
      - web/src-tauri/target/release/bundle/msi/*.msi
    expire_in: 1 week
  only:
    - tags

build-linux:
  stage: build
  image: ubuntu:22.04
  script:
    - apt-get update && apt-get install -y curl nodejs npm cargo rustc libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf
    - cd web
    - npm ci
    - npm run build
    - cargo install tauri-cli --version "^2.0"
    - cargo tauri build --bundles deb,appimage
  artifacts:
    paths:
      - web/src-tauri/target/release/bundle/deb/*.deb
      - web/src-tauri/target/release/bundle/appimage/*.AppImage
    expire_in: 1 week
  only:
    - tags
